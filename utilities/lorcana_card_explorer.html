<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Lorcana - Ultimate Card Analyzer</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #16213e;
            --secondary-color: #0f3460;
            --accent-color: #e94560;
            --text-color: #dcdcdc;
            --text-muted: #888;
            --border-color: #3a3a5a;
            --amber: #fecb00;
            --amethyst: #9754cb;
            --emerald: #00975e;
            --ruby: #d40026;
            --sapphire: #0072b1;
            --steel: #465568;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
        }

        header h1 {
            color: var(--accent-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 370px 1fr;
            gap: 30px;
            align-items: flex-start;
        }

        /* Loading Spinner */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }
        
        .loader {
            border: 8px solid var(--primary-color);
            border-top: 8px solid var(--accent-color);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }

        #loader-overlay p {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Left Panel - Search and Card Display */
        .left-panel {
            position: sticky;
            top: 20px;
        }
        
        #search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        #search-box {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #search-box:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.3);
        }

        #search-results {
            position: absolute;
            width: 100%;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: var(--accent-color);
        }
        
        .search-result-item .ink-icon {
            width: 20px;
            height: 20px;
        }
        
        #card-display {
            background-color: var(--primary-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        #card-image-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
        }
        
        #card-image-container img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        #welcome-message {
            color: var(--text-muted);
        }

        /* Right Panel - Analysis */
        #analysis-panel {
            background-color: var(--primary-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            min-height: 500px;
        }

        .analysis-section {
            margin-bottom: 2rem;
        }

        .analysis-section h2 {
            font-size: 1.5rem;
            color: var(--accent-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-color: var(--accent-color);
        }

        .stat-item-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .stat-item-explanation {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .stat-item-value-container {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .stat-item-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-item-percentage {
            font-size: 1rem;
            font-weight: normal;
            color: var(--text-muted);
        }
        
        .stat-breakdown {
            margin-top: auto; /* Pushes to the bottom */
            padding-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .color-chip {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-chip:hover {
            transform: scale(1.1);
        }

        /* Modal */
        #results-modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #modal-content {
            background-color: var(--bg-color);
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        
        #modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        #modal-title {
            color: var(--accent-color);
            font-size: 1.5rem;
        }
        
        #close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        #close-modal:hover {
            color: var(--accent-color);
        }

        #modal-body {
            overflow-y: auto;
            padding-right: 10px;
        }

        #modal-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .modal-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .modal-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--accent-color);
        }

        .modal-card img {
            width: 100%;
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .left-panel {
                position: static;
            }
        }
        @media (max-width: 500px) {
            header h1 {
                font-size: 1.8rem;
            }
            .stat-grid {
                grid-template-columns: 1fr;
            }
            #modal-card-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader"></div>
        <p id="loader-text">Loading Lorcana Database...</p>
    </div>

    <div class="container">
        <header>
            <h1>Ultimate Lorcana Card Analyzer</h1>
            <p>Fuzzy search for a card to begin a deep-dive statistical analysis.</p>
        </header>

        <main class="main-layout">
            <div class="left-panel">
                <div id="search-container">
                    <input type="text" id="search-box" placeholder="Search for a card (e.g., 'mickey brave')">
                    <div id="search-results"></div>
                </div>
                <div id="card-display">
                    <div id="card-image-container">
                         <p id="welcome-message">Search for a card to display it here.</p>
                    </div>
                </div>
            </div>
            <div id="analysis-panel">
                <p id="analysis-prompt">Analysis results will appear here once a card is selected.</p>
            </div>
        </main>
    </div>

    <div id="results-modal">
        <div id="modal-content">
            <div id="modal-header">
                <h2 id="modal-title">Matching Cards</h2>
                <span id="close-modal">&times;</span>
            </div>
            <div id="modal-body">
                <div id="modal-card-grid"></div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <script src="https://cdn.jsdelivr.net/gh/heavenideas/heavenideas.github.io@main/utilities/unified_win_probability_utilities.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                allCards: [],
                characterCards: [],
                totalCardCount: 0,
                totalCharacterCount: 0,
                fuse: null,
                abilitiesConfig: null,
                currentCardMetrics: null,
                cardAbilityMap: new Map(), // card.id -> [abilityName, ...]
                abilityStats: {}, // abilityName -> { total, byColor: { Amber, ... } }
                COLORS: ["Amber", "Amethyst", "Emerald", "Ruby", "Sapphire", "Steel"],
                COLOR_HEX: {
                    Amber: '#fecb00', Amethyst: '#9754cb', Emerald: '#00975e',
                    Ruby: '#d40026', Sapphire: '#0072b1', Steel: '#465568'
                }
            };

            const ui = {
                loaderOverlay: document.getElementById('loader-overlay'),
                loaderText: document.getElementById('loader-text'),
                searchBox: document.getElementById('search-box'),
                searchResults: document.getElementById('search-results'),
                searchContainer: document.getElementById('search-container'),
                cardDisplay: document.getElementById('card-display'),
                cardImageContainer: document.getElementById('card-image-container'),
                analysisPanel: document.getElementById('analysis-panel'),
                modal: document.getElementById('results-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalCardGrid: document.getElementById('modal-card-grid'),
                closeModalBtn: document.getElementById('close-modal'),
                welcomeMessage: document.getElementById('welcome-message'),
                analysisPrompt: document.getElementById('analysis-prompt'),
            };

            async function initialize() {
                try {
                    // 1. Fetch all cards data
                    const cardsResponse = await fetch('https://cdn.jsdelivr.net/gh/heavenideas/similcana@main/database/allCards.json');
                    if (!cardsResponse.ok) throw new Error(`HTTP error! status: ${cardsResponse.status}`);
                    const allCardsData = await cardsResponse.json();
                    state.allCards = allCardsData.cards.filter(c => c.type === "Character" || c.type === "Action" || c.type === "Item");
                    state.characterCards = state.allCards.filter(c => c.type === 'Character');
                    state.totalCardCount = state.allCards.length;
                    state.totalCharacterCount = state.characterCards.length;


                    // 2. Load abilities library
                    ui.loaderText.textContent = 'Initializing Analysis Engine...';
                    await UnifiedWinProbabiliyCalculation.loadAbilitiesConfig();
                    state.abilitiesConfig = UnifiedWinProbabiliyCalculation.getAbilitiesConfig();

                    // 3. Pre-process data for performance
                    ui.loaderText.textContent = 'Analyzing the Multiverse (this may take a moment)...';
                    await new Promise(resolve => setTimeout(() => {
                        preprocessData();
                        resolve();
                    }, 10));


                    // 4. Setup search
                    const options = {
                        includeScore: true,
                        keys: ['simpleName', 'fullName'],
                        threshold: 0.4
                    };
                    state.fuse = new Fuse(state.allCards, options);

                    ui.loaderOverlay.style.display = 'none';
                    setupEventListeners();
                } catch (error) {
                    console.error("Initialization failed:", error);
                    ui.loaderText.innerHTML = `Failed to load resources. <br>Please check your connection and refresh the page. Details: ${error.message}`;
                }
            }

            function preprocessData() {
                for (const card of state.allCards) {
                    try {
                        const cardToProcess = { ...card, fullTextSections: card.fullTextSections || [] };
                        const metrics = UnifiedWinProbabiliyCalculation.calculateCardMetrics(cardToProcess);
                        const cardAbilities = metrics.breakdown.map(b => b.abilityName);
                        state.cardAbilityMap.set(card.id, cardAbilities);
                        
                        for (const abilityName of cardAbilities) {
                            if (!state.abilityStats[abilityName]) {
                                state.abilityStats[abilityName] = { total: 0, byColor: {} };
                                state.COLORS.forEach(c => state.abilityStats[abilityName].byColor[c] = 0);
                            }
                            state.abilityStats[abilityName].total++;
                            getCardColors(card).forEach(color => {
                                if (state.abilityStats[abilityName].byColor[color] !== undefined) {
                                    state.abilityStats[abilityName].byColor[color]++;
                                }
                            });
                        }
                    } catch (e) {
                        // console.warn(`Could not process card ${card.fullName}: ${e.message}`);
                    }
                }
            }


            function setupEventListeners() {
                ui.searchBox.addEventListener('input', handleSearchInput);
                document.addEventListener('click', (e) => {
                    if (!ui.searchContainer.contains(e.target)) {
                        ui.searchResults.innerHTML = '';
                    }
                });
                ui.closeModalBtn.addEventListener('click', () => ui.modal.style.display = 'none');
                window.addEventListener('click', (e) => {
                    if (e.target == ui.modal) {
                        ui.modal.style.display = 'none';
                    }
                });

                // Event delegation for analysis panel clicks
                ui.analysisPanel.addEventListener('click', (e) => {
                    const colorChip = e.target.closest('.color-chip');
                    const statItem = e.target.closest('.stat-item');

                    if (!statItem || !state.currentCardMetrics) return;

                    const criteria = JSON.parse(statItem.dataset.criteria);
                    const title = statItem.querySelector('.stat-item-header').textContent;
                    const analyzedCard = state.allCards.find(c => c.id === state.currentCardMetrics.card.id);

                    if (colorChip) {
                        e.stopPropagation();
                        const colorFilter = colorChip.dataset.color;
                        showDrillDownResults(criteria, title, analyzedCard, colorFilter);
                    } else {
                        showDrillDownResults(criteria, title, analyzedCard, null);
                    }
                });
            }
            
            function getCardColors(card) {
                return card.colors || (card.color ? [card.color] : []);
            }

            function handleSearchInput(e) {
                const query = e.target.value;
                if (query.length < 3) {
                    ui.searchResults.innerHTML = '';
                    return;
                }
                const results = state.fuse.search(query).slice(0, 7);
                ui.searchResults.innerHTML = results.map(result => {
                    const card = result.item;
                    const colors = getCardColors(card);
                    const colorIcons = colors.map(color => 
                        `<div style="width:20px; height:20px; background-color:${state.COLOR_HEX[color] || '#ccc'}; border-radius:50%;" title="${color}"></div>`
                    ).join('');
                    return `
                        <div class="search-result-item" data-card-id="${card.id}">
                            <div style="display: flex; gap: 5px;">${colorIcons}</div>
                            <span>${card.fullName}</span>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const cardId = parseInt(item.dataset.cardId);
                        analyzeCard(cardId);
                        ui.searchResults.innerHTML = '';
                        ui.searchBox.value = '';
                    });
                });
            }

            function analyzeCard(cardId) {
                const card = state.allCards.find(c => c.id === cardId);
                if (!card) return;
                
                if (ui.welcomeMessage) ui.welcomeMessage.style.display = 'none';
                if (ui.analysisPrompt) ui.analysisPrompt.style.display = 'none';

                ui.cardImageContainer.innerHTML = `<img src="${card.images.full}" alt="${card.fullName}" id="current-card-image">`;
                
                const cardToProcess = { ...card, fullTextSections: card.fullTextSections || [] };
                state.currentCardMetrics = { ...UnifiedWinProbabiliyCalculation.calculateCardMetrics(cardToProcess), card: card };

                renderAnalysis(card, state.currentCardMetrics);
                
                if (window.innerWidth <= 900) {
                   ui.analysisPanel.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            function renderAnalysis(card, metrics) {
                ui.analysisPanel.innerHTML = `
                    ${renderAbilityAnalysis(card, metrics)}
                    ${renderStaticStatAnalysis(card)}
                    ${renderComparativeStatAnalysis(card)}
                `;
            }
            
            function renderAbilityAnalysis(card, metrics) {
                 if (!metrics || metrics.breakdown.length === 0) return '';
                 
                 const abilityItems = metrics.breakdown.map(breakdownItem => {
                     const abilityName = breakdownItem.abilityName;
                     const stats = state.abilityStats[abilityName];
                     if (!stats) return '';
                     
                     const breakdownChips = Object.entries(stats.byColor)
                        .filter(([_, count]) => count > 0)
                        .map(([color, count]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${count}</div>`)
                        .join('');
                     
                     const criteria = { type: 'ability', value: abilityName };
                     const otherCardsCount = stats.total > 0 ? stats.total - 1 : 0;
                     const percentage = ((otherCardsCount / state.totalCardCount) * 100).toFixed(1);

                     return `
                        <div class="stat-item" data-criteria='${JSON.stringify(criteria)}'>
                           <div class="stat-item-header">${abilityName.replace(/keyword: /i, '')}</div>
                           <div class="stat-item-explanation">${breakdownItem.explanation}</div>
                           <div class="stat-item-value-container">
                                <div class="stat-item-value">${otherCardsCount}</div>
                                <div class="stat-item-percentage">(${percentage}%)</div>
                           </div>
                           <div class="stat-item-header" style="font-size:0.9rem; margin-top:5px; color:var(--text-muted)">Other cards with this ability</div>
                           <div class="stat-breakdown">${breakdownChips}</div>
                        </div>
                     `;
                 }).join('');
                 
                 return `
                    <div class="analysis-section">
                        <h2>Ability Analysis</h2>
                        <div class="stat-grid">${abilityItems}</div>
                    </div>
                 `;
            }
            
            function renderStaticStatAnalysis(card) {
                if(card.type !== 'Character') return '';

                const criteria = { 
                    type: 'static', 
                    stats: { cost: card.cost, strength: card.strength, willpower: card.willpower, lore: card.lore } 
                };

                const matchingCards = findMatchingCards(criteria, card);
                const otherCards = matchingCards.filter(c => c.id !== card.id);
                const count = otherCards.length;
                const percentage = ((count / state.totalCharacterCount) * 100).toFixed(1);
                
                const breakdown = countByColor(otherCards);
                const breakdownChips = Object.entries(breakdown)
                    .filter(([_, num]) => num > 0)
                    .map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`)
                    .join('');

                return `
                    <div class="analysis-section">
                        <h2>Identical Stats Profile</h2>
                        <div class="stat-grid">
                            <div class="stat-item" data-criteria='${JSON.stringify(criteria)}'>
                               <div class="stat-item-header">Cost ${card.cost} | ¤ ${card.strength} | ⛉ ${card.willpower} | ◊ ${card.lore || 0}</div>
                               <div class="stat-item-value-container">
                                    <div class="stat-item-value">${count}</div>
                                    <div class="stat-item-percentage">(${percentage}%)</div>
                               </div>
                               <div class="stat-item-header" style="font-size:0.9rem; margin-top:5px; color:var(--text-muted)">Other cards with identical stats</div>
                               <div class="stat-breakdown">${breakdownChips}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderComparativeStatAnalysis(card) {
                 if(card.type !== 'Character') return '';

                 const statsToCompare = ['strength', 'willpower', 'lore'];
                 let html = `<div class="analysis-section"><h2>Combat & Stat Analysis</h2><div class="stat-grid">`;

                 statsToCompare.forEach(stat => {
                     // MORE THAN
                     const moreCriteria = { type: 'comparative', stat: stat, comparison: '>' };
                     const moreCards = findMatchingCards(moreCriteria, card);
                     const morePercentage = ((moreCards.length / state.totalCharacterCount) * 100).toFixed(1);
                     const moreBreakdown = countByColor(moreCards);
                     const moreChips = Object.entries(moreBreakdown)
                        .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');
                     
                     html += `
                        <div class="stat-item" data-criteria='${JSON.stringify(moreCriteria)}'>
                            <div class="stat-item-header">Higher ${stat.charAt(0).toUpperCase() + stat.slice(1)} ${stat === 'lore' ? '(at same cost)' : ''}</div>
                            <div class="stat-item-value-container">
                                <div class="stat-item-value">${moreCards.length}</div>
                                <div class="stat-item-percentage">(${morePercentage}%)</div>
                            </div>
                            <div class="stat-breakdown">${moreChips}</div>
                        </div>
                     `;

                     // LESS THAN
                     const lessCriteria = { type: 'comparative', stat: stat, comparison: '<' };
                     const lessCards = findMatchingCards(lessCriteria, card);
                     const lessPercentage = ((lessCards.length / state.totalCharacterCount) * 100).toFixed(1);
                     const lessBreakdown = countByColor(lessCards);
                     const lessChips = Object.entries(lessBreakdown)
                        .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                     html += `
                        <div class="stat-item" data-criteria='${JSON.stringify(lessCriteria)}'>
                            <div class="stat-item-header">Lower ${stat.charAt(0).toUpperCase() + stat.slice(1)} ${stat === 'lore' ? '(at same cost)' : ''}</div>
                             <div class="stat-item-value-container">
                                <div class="stat-item-value">${lessCards.length}</div>
                                <div class="stat-item-percentage">(${lessPercentage}%)</div>
                            </div>
                            <div class="stat-breakdown">${lessChips}</div>
                        </div>
                     `;
                 });

                // --- Favorable Trades ---
                const favorableCriteria = { type: 'trade', comparison: 'favorable' };
                const favorableCards = findMatchingCards(favorableCriteria, card);
                const favorablePercentage = ((favorableCards.length / state.totalCharacterCount) * 100).toFixed(1);
                const favorableBreakdown = countByColor(favorableCards);
                const favorableChips = Object.entries(favorableBreakdown)
                    .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                html += `
                    <div class="stat-item" data-criteria='${JSON.stringify(favorableCriteria)}'>
                        <div class="stat-item-header">Favorable Trades (Banish & Survive)</div>
                        <div class="stat-item-value-container">
                            <div class="stat-item-value">${favorableCards.length}</div>
                            <div class="stat-item-percentage">(${favorablePercentage}%)</div>
                        </div>
                        <div class="stat-breakdown">${favorableChips}</div>
                    </div>
                `;

                // --- Unfavorable Trades ---
                const unfavorableCriteria = { type: 'trade', comparison: 'unfavorable' };
                const unfavorableCards = findMatchingCards(unfavorableCriteria, card);
                const unfavorablePercentage = ((unfavorableCards.length / state.totalCharacterCount) * 100).toFixed(1);
                const unfavorableBreakdown = countByColor(unfavorableCards);
                const unfavorableChips = Object.entries(unfavorableBreakdown)
                    .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                html += `
                    <div class="stat-item" data-criteria='${JSON.stringify(unfavorableCriteria)}'>
                        <div class="stat-item-header">Unfavorable Trades (Get Banished & Opponent Survives)</div>
                        <div class="stat-item-value-container">
                            <div class="stat-item-value">${unfavorableCards.length}</div>
                            <div class="stat-item-percentage">(${unfavorablePercentage}%)</div>
                        </div>
                        <div class="stat-breakdown">${unfavorableChips}</div>
                    </div>
                `;

                // --- Mutual Banish Favorable Ink ---
                const mutualFavCriteria = { type: 'mutual_trade', comparison: 'favorable_ink' };
                const mutualFavCards = findMatchingCards(mutualFavCriteria, card);
                const mutualFavPercentage = ((mutualFavCards.length / state.totalCharacterCount) * 100).toFixed(1);
                const mutualFavBreakdown = countByColor(mutualFavCards);
                const mutualFavChips = Object.entries(mutualFavBreakdown)
                    .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                html += `
                    <div class="stat-item" data-criteria='${JSON.stringify(mutualFavCriteria)}'>
                        <div class="stat-item-header">Mutual Banish (Favorable ⬡)</div>
                        <div class="stat-item-value-container">
                            <div class="stat-item-value">${mutualFavCards.length}</div>
                            <div class="stat-item-percentage">(${mutualFavPercentage}%)</div>
                        </div>
                        <div class="stat-breakdown">${mutualFavChips}</div>
                    </div>
                `;
                
                // --- Mutual Banish Neutral Ink ---
                const mutualNeuCriteria = { type: 'mutual_trade', comparison: 'neutral_ink' };
                const mutualNeuCards = findMatchingCards(mutualNeuCriteria, card);
                const mutualNeuPercentage = ((mutualNeuCards.length / state.totalCharacterCount) * 100).toFixed(1);
                const mutualNeuBreakdown = countByColor(mutualNeuCards);
                const mutualNeuChips = Object.entries(mutualNeuBreakdown)
                    .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                html += `
                    <div class="stat-item" data-criteria='${JSON.stringify(mutualNeuCriteria)}'>
                        <div class="stat-item-header">Mutual Banish (Neutral ⬡)</div>
                        <div class="stat-item-value-container">
                            <div class="stat-item-value">${mutualNeuCards.length}</div>
                            <div class="stat-item-percentage">(${mutualNeuPercentage}%)</div>
                        </div>
                        <div class="stat-breakdown">${mutualNeuChips}</div>
                    </div>
                `;

                // --- Mutual Banish Unfavorable Ink ---
                const mutualUnfavCriteria = { type: 'mutual_trade', comparison: 'unfavorable_ink' };
                const mutualUnfavCards = findMatchingCards(mutualUnfavCriteria, card);
                const mutualUnfavPercentage = ((mutualUnfavCards.length / state.totalCharacterCount) * 100).toFixed(1);
                const mutualUnfavBreakdown = countByColor(mutualUnfavCards);
                const mutualUnfavChips = Object.entries(mutualUnfavBreakdown)
                    .filter(([_, num]) => num > 0).map(([color, num]) => `<div class="color-chip" data-color="${color}" style="background-color:${state.COLOR_HEX[color]}">${num}</div>`).join('');

                html += `
                    <div class="stat-item" data-criteria='${JSON.stringify(mutualUnfavCriteria)}'>
                        <div class="stat-item-header">Mutual Banish (Unfavorable ⬡)</div>
                        <div class="stat-item-value-container">
                            <div class="stat-item-value">${mutualUnfavCards.length}</div>
                            <div class="stat-item-percentage">(${mutualUnfavPercentage}%)</div>
                        </div>
                        <div class="stat-breakdown">${mutualUnfavChips}</div>
                    </div>
                `;


                 html += '</div></div>';
                 return html;
            }

            function findMatchingCards(criteria, analyzedCard) {
                // Ability search needs to check all cards, not just characters
                const cardPool = criteria.type === 'ability' ? state.allCards : state.characterCards;

                return cardPool.filter(c => {
                    if (c.id === analyzedCard.id && criteria.type !== 'ability') return false;

                    const opponentWillpower = c.willpower || 0;
                    const opponentStrength = c.strength || 0;
                    const opponentCost = c.cost || 0;
                    const yourWillpower = analyzedCard.willpower || 0;
                    const yourStrength = analyzedCard.strength || 0;
                    const yourCost = analyzedCard.cost || 0;

                    switch (criteria.type) {
                        case 'ability':
                            return (state.cardAbilityMap.get(c.id) || []).includes(criteria.value);
                        case 'static':
                             return c.cost === criteria.stats.cost &&
                                   c.strength === criteria.stats.strength &&
                                   c.willpower === criteria.stats.willpower &&
                                   (c.lore || 0) === (criteria.stats.lore || 0);
                        case 'comparative':
                            if (criteria.stat === 'lore' && c.cost !== analyzedCard.cost) return false;
                            const cardStat = c[criteria.stat] || 0;
                            const analyzedStat = analyzedCard[criteria.stat] || 0;
                            if (criteria.comparison === '>') return cardStat > analyzedStat;
                            if (criteria.comparison === '<') return cardStat < analyzedStat;
                            return false;
                        case 'trade':
                            if (criteria.comparison === 'favorable') {
                                return opponentWillpower <= yourStrength && yourWillpower > opponentStrength;
                            }
                            if (criteria.comparison === 'unfavorable') {
                                return opponentStrength >= yourWillpower && yourStrength < opponentWillpower;
                            }
                            return false;
                        case 'mutual_trade':
                            const isMutualBanish = opponentWillpower > 0 && opponentWillpower <= yourStrength && yourWillpower <= opponentStrength;
                            if (!isMutualBanish) return false;

                            if (criteria.comparison === 'favorable_ink') return yourCost < opponentCost;
                            if (criteria.comparison === 'neutral_ink') return yourCost === opponentCost;
                            if (criteria.comparison === 'unfavorable_ink') return yourCost > opponentCost;
                            return false;
                        default:
                            return false;
                    }
                });
            }
            
            function countByColor(cards) {
                const counts = {};
                state.COLORS.forEach(c => counts[c] = 0);
                cards.forEach(card => {
                    getCardColors(card).forEach(color => {
                        if (counts[color] !== undefined) counts[color]++;
                    });
                });
                return counts;
            }

            function showDrillDownResults(criteria, title, analyzedCard, colorFilter = null) {
                 const matchingCards = findMatchingCards(criteria, analyzedCard);
                 
                 let cardsToShow = (criteria.type === 'ability' || criteria.type === 'static') 
                    ? matchingCards.filter(c => c.id !== analyzedCard.id) 
                    : matchingCards;

                 let modalTitleText = `${title}`;
                 if (colorFilter) {
                    cardsToShow = cardsToShow.filter(c => getCardColors(c).includes(colorFilter));
                    modalTitleText += ` (${colorFilter})`;
                 }
                 modalTitleText += ` (${cardsToShow.length} cards)`;
                 ui.modalTitle.textContent = modalTitleText;
                 
                 ui.modalCardGrid.innerHTML = cardsToShow.map(card => `
                    <div class="modal-card" data-card-id="${card.id}">
                        <img src="${card.images.thumbnail}" alt="${card.fullName}" loading="lazy">
                    </div>
                 `).join('');

                 document.querySelectorAll('.modal-card').forEach(cardElement => {
                     cardElement.addEventListener('click', () => {
                         const cardId = parseInt(cardElement.dataset.cardId);
                         ui.modal.style.display = 'none';
                         analyzeCard(cardId);
                     });
                 });

                 ui.modal.style.display = 'flex';
            }

            initialize();
        });
    </script>
</body>
</html>
