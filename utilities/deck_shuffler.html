<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorcana Deck Draw Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load Unified Win Probability Utilities -->
    <!-- We use jsDelivr CDN to ensure correct MIME types -->
    <script src="https://cdn.jsdelivr.net/gh/heavenideas/heavenideas.github.io@main/utilities/unified_win_probability_utilities.js"></script>
    <script src="card_stat_analysis_module.js"></script>
    <script src="CardThreatLevelInspector.js"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6a6a6a;
        }
        /* Basic styles for Inter font and dark mode */
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
            height: 100%;
        }
        /* Style for the card tooltips */
        .card-tooltip {
            display: none;
            position: absolute;
            bottom: 110%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .card-tooltip-trigger:hover + .card-tooltip,
        .card-tooltip-trigger:focus + .card-tooltip {
            display: block;
        }
    </style>
    <!-- Import Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center z-50">
        <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-message" class="text-white text-lg mt-4">Initializing...</p>
    </div>

    <!-- Main Content Grid -->
    <div class="container mx-auto max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Deck Input -->
        <div class="lg:col-span-1 p-4 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-white">Deck Input</h2>
            <p class="text-sm text-gray-400 mb-3">Paste your decklist below. Format: <br><code class="bg-gray-700 p-1 rounded">4x Card Name</code> or <code class="bg-gray-700 p-1 rounded">4 Card Name</code></p>

            <label for="deck-select" class="block text-sm font-medium text-gray-300 mb-1">Load from My Decks</label>
            <select id="deck-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none mb-3">
                <option value="">Select a deck...</option>
            </select>

            <textarea id="decklist-input" class="w-full h-80 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="4x Mickey Mouse - Brave Little Tailor&#10;2x Lilo - Making a Wish&#10;..."></textarea>
            
            <button id="load-deck-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50" disabled>
                Load Deck & Analyze
            </button>
            <p id="deck-load-status" class="text-sm text-center mt-3 h-4"></p>
        </div>

        <!-- Right Column: Analyzer Tabs -->
        <div class="lg:col-span-2">
            <!-- Tab Headers -->
            <div class="bg-gray-800 rounded-lg p-1.5 inline-flex items-center justify-center">
                <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline h-4 w-4 mr-1.5"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"></path><path d="m18 2 4 4-4 4"></path><path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"></path><path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"></path><path d="m18 14 4 4-4 4"></path></svg>
                    Draw
                </button>
                <!-- Other tabs could be added here -->
            </div>

            <!-- Tab Content -->
            <div id="analyzer-content" class="mt-4 space-y-6 opacity-50 pointer-events-none">
                
                <!-- Deck Shuffle Simulator -->
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-blue-400"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                            Deck Shuffle Simulator
                        </h3>
                        <p class="text-sm text-gray-400 mt-2">Simulate shuffles using the Fisher-Yates algorithm.</p>
                    </div>
                    <div class="p-6 pt-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Shuffle Controls -->
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <button id="shuffle-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-11 px-8 flex-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"></path><path d="m18 2 4 4-4 4"></path><path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"></path><path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"></path><path d="m18 14 4 4-4 4"></path></svg>
                                        Shuffle Deck
                                    </button>
                                    <button id="reset-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gray-700 text-white hover:bg-gray-600 h-11 px-8">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>
                                        Reset
                                    </button>
                                </div>
                                <!-- Hand Quality -->
                                <div id="hand-quality-container" class="space-y-3 pt-2 hidden">
                                    <p class="text-xs text-gray-500">Hand Quality</p>
                                    <div class="flex items-center gap-3">
                                        <span id="hand-quality-score" class="text-3xl font-bold tabular-nums text-indigo-400">0.0<span class="text-lg text-gray-500">/10</span></span>
                                        <div id="hand-quality-rating" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold"></div>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                                        <div id="hand-quality-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Recent Shuffles -->
                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-gray-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                    <h3 class="text-sm font-medium text-white">Recent Shuffles</h3>
                                </div>
                                <div id="recent-shuffles-list" class="space-y-2 max-h-36 overflow-y-auto pr-2">
                                    <p class="text-xs text-gray-500 text-center py-4">Shuffle the deck to see results.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hand Analysis -->
                <div id="hand-analysis-container" class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 overflow-hidden hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-white">Hand Analysis</h3>
                        <p class="text-sm text-gray-400 mt-2">Compare your opening hand with early game potential.</p>
                    </div>
                    <div class="p-6 pt-0">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Opening Hand -->
                            <div class="space-y-4 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-sm font-semibold text-white">Opening Hand (7 Cards)</h3>
                                    <div id="opening-hand-rating" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold"></div>
                                </div>
                                <div id="opening-hand-analysis-points" class="space-y-1 text-sm"></div>
                                <!-- Stats Grid -->
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="space-y-1"><p class="text-gray-500">Inkable</p><p id="hand-inkable-stat" class="font-bold text-lg text-white"></p></div>
                                    <div class="space-y-1"><p class="text-gray-500">Curve</p><div id="hand-curve-stat" class="flex flex-wrap gap-1"></div></div>
                                    <div class="space-y-1"><p class="text-gray-500">Types</p><div id="hand-types-stat" class="flex flex-wrap gap-1"></div></div>
                                    <div class="space-y-1"><p class="text-gray-500">Colors</p><div id="hand-colors-stat" class="flex flex-wrap gap-1"></div></div>
                                </div>
                                <!-- Card Images -->
                                <div class="w-full overflow-x-auto">
                                    <div id="hand-card-images" class="grid grid-cols-7 gap-1 w-max sm:w-full"></div>
                                </div>
                                <div id="hand-comparison" class="pt-2 space-y-1 text-sm"></div>
                            </div>
                            
                            <!-- Early Game -->
                            <div class="space-y-4 min-w-0">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-white"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
                                    <h3 class="text-sm font-semibold text-white">Early Game (First 15 Cards)</h3>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="space-y-1"><p class="text-gray-500">Inkable</p><p id="early-inkable-stat" class="font-bold text-lg text-white"></p></div>
                                    <div class="space-y-1"><p class="text-gray-500">Curve</p><div id="early-curve-stat" class="flex flex-wrap gap-1"></div></div>
                                    <div class="space-y-1"><p class="text-gray-500">Types</p><div id="early-types-stat" class="flex flex-wrap gap-1"></div></div>
                                    <div class="space-y-1"><p class="text-gray-500">Colors</p><div id="early-colors-stat" class="flex flex-wrap gap-1"></div></div>
                                </div>
                                <div id="early-tags-stat" class="flex flex-wrap gap-2 text-sm"></div>
                                <p class="pt-2 text-sm text-gray-500">Showing analysis of cards 1-15 from this shuffle.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Deck Timeline -->
                    <div id="deck-timeline-container" class="w-full min-w-0 border-t border-gray-700 p-6">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <h3 id="deck-timeline-header" class="text-sm font-semibold text-white">Deck Timeline</h3>
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <span>Scroll to see turn progression</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                                </div>
                            </div>
                            <div class="w-full overflow-x-auto overflow-y-hidden pb-4">
                                <div id="deck-timeline-cards" class="flex gap-4 w-max"></div>
                            </div>
                            <div class="flex items-center justify-center gap-4 text-xs text-gray-500 pt-2">
                                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>Early (T1-7)</span></div>
                                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-yellow-500 rounded-full"></div><span>Mid (T8-14)</span></div>
                                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-purple-500 rounded-full"></div><span>Late (T15+)</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shuffle Quality Analysis -->
                <div id="shuffle-quality-container" class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 hidden">
                    <div class="p-6">
                        <h3 class="text-xl leading-none font-bold text-white flex items-center justify-between">
                            <span>Shuffle Quality Analysis</span>
                            <div id="shuffle-quality-rating" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold"></div>
                        </h3>
                        <p class="text-sm text-gray-400 mt-2">Statistical analysis of shuffle randomization.</p>
                    </div>
                    <div class="p-6 pt-0 space-y-4">
                        <div class="space-y-2">
                            <div id="shuffle-quality-issues" class="space-y-1 text-sm"></div>
                        </div>
                        <button id="toggle-stats-button" type="button" class="w-full flex items-center justify-center gap-2 py-2 text-sm text-gray-500 hover:text-white transition-colors border-t border-gray-700 pt-4">
                            <svg id="toggle-stats-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 transition-transform"><path d="m6 9 6 6 6-6"></path></svg>
                            <span id="toggle-stats-text">Show Detailed Statistics</span>
                        </button>
                        <div id="detailed-stats-container" class="pt-4 border-t border-gray-700 hidden">
                            <div class="space-y-4">
                                <!-- Cluster/Consecutive Stats -->
                                <div class="space-y-2">
                                    <h4 class="text-sm font-semibold text-white">Consecutive Same Cards</h4>
                                    <div id="consecutive-cards-stat" class="grid grid-cols-3 gap-2 text-sm"></div>
                                </div>
                                <div class="space-y-2">
                                    <h4 class="text-sm font-semibold text-white">Clustering Analysis</h4>
                                    <div id="clustering-stat" class="grid grid-cols-2 gap-3 text-sm"></div>
                                </div>
                                <!-- Alert Box -->
                                <div id="clustering-alert-box" class="hidden relative w-full rounded-lg border border-yellow-700 bg-yellow-900 text-yellow-300 p-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-alert h-4 w-4 absolute left-4 top-4"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line></svg>
                                    <div id="clustering-alert-text" class="ml-7 text-sm"></div>
                                </div>
                                <!-- Distribution -->
                                <div class="space-y-2">
                                    <h4 class="text-sm font-semibold text-white flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>Distribution (Full Deck)</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="text-gray-500">Colors:</span><div id="dist-colors-stat" class="flex flex-wrap gap-1 mt-1"></div></div>
                                        <div><span class="text-gray-500">Costs:</span><div id="dist-costs-stat" class="flex flex-wrap gap-1 mt-1"></div></div>
                                        <div><span class="text-gray-500">Inkwell:</span><div id="dist-inkwell-stat" class="flex flex-wrap gap-1 mt-1"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Probability Calculators -->
                <div class="grid gap-6 md:grid-cols-2">
                    <!-- Hand Draw Probabilities -->
                    <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-white">Hand Draw Probabilities</h3>
                            <p class="text-sm text-gray-400 mt-2">Probability of drawing cards by category in opening hand (7 cards).</p>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="rounded-md border border-gray-700">
                                <div class="relative w-full overflow-auto">
                                    <table class="w-full caption-bottom text-sm">
                                        <thead class="[&_tr]:border-b border-gray-700">
                                            <tr class="border-b border-gray-700 transition-colors">
                                                <th class="h-12 px-4 text-left align-middle font-medium text-white w-[160px]">Category</th>
                                                <th class="h-12 px-4 align-middle font-medium text-white text-center">0</th>
                                                <th class="h-12 px-4 align-middle font-medium text-white text-center">1</th>
                                                <th class="h-12 px-4 align-middle font-medium text-white text-center">2</th>
                                                <th class="h-12 px-4 align-middle font-medium text-white text-center">3</th>
                                                <th class="h-12 px-4 align-middle font-medium text-white text-center">4+</th>
                                            </tr>
                                        </thead>
                                        <tbody id="probability-table-body" class="[&_tr:last-child]:border-0">
                                            <!-- Rows will be injected by JS -->
                                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Load a deck to see probabilities.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hypergeometric Calculator -->
                    <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-white">Hypergeometric Calculator</h3>
                            <p class="text-sm text-gray-400 mt-2">Calculate draw probabilities for specific cards.</p>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="space-y-4">
                                <div class="flex flex-wrap items-end gap-3">
                                    <div class="flex items-center gap-2">
                                        <input class="flex h-8 w-16 text-center text-sm rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-white" id="hyper-deck-size" type="number" value="60">
                                        <span class="text-sm text-gray-500">Deck</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input class="flex h-8 w-16 text-center text-sm rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-white" id="hyper-copies" type="number" value="4">
                                        <span class="text-sm text-gray-500">Copies</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input class="flex h-8 w-16 text-center text-sm rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-white" id="hyper-hand-size" type="number" value="7">
                                        <span class="text-sm text-gray-500">Hand</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input class="flex h-8 w-16 text-center text-sm rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-white" id="hyper-desired" type="number" value="1">
                                        <span class="text-sm text-gray-500">Desired</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                                    <div class="flex items-center gap-2"><span class="text-gray-500">≥ 1:</span><span id="hyper-gte" class="font-mono font-semibold text-white">...</span></div>
                                    <div class="flex items-center gap-2"><span class="text-gray-500">= 1:</span><span id="hyper-eq" class="font-mono font-semibold text-white">...</span></div>
                                    <div class="flex items-center gap-2"><span class="text-gray-500">&lt; 1:</span><span id="hyper-lt" class="font-mono font-semibold text-white">...</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // --- GLOBAL STATE ---
        let allCardsData = [];
        let allDecks = [];
        let decklist = []; // Array of full card objects, expanded by quantity (e.g., 60 cards)
        let deckInfo = {}; // Parsed deck info (counts, etc.)
        let shuffledDeck = [];
        let openingHand = [];
        let recentShuffles = []; // Stores { id, hand, score, rating }
        let currentShuffleAnalysis = {}; // Holds all analysis data for the current shuffle
        let combinationsCache = {}; // Cache for combinations function
        let cardInspector = null; // Card Threat Level Inspector instance

        // --- DOM ELEMENTS ---
        const DOMElements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingMessage: document.getElementById('loading-message'),
            deckSelect: document.getElementById('deck-select'),
            decklistInput: document.getElementById('decklist-input'),
            loadDeckButton: document.getElementById('load-deck-button'),
            deckLoadStatus: document.getElementById('deck-load-status'),
            analyzerContent: document.getElementById('analyzer-content'),
            
            // Shuffle Sim
            shuffleButton: document.getElementById('shuffle-button'),
            resetButton: document.getElementById('reset-button'),
            handQualityContainer: document.getElementById('hand-quality-container'),
            handQualityScore: document.getElementById('hand-quality-score'),
            handQualityRating: document.getElementById('hand-quality-rating'),
            handQualityBar: document.getElementById('hand-quality-bar'),
            recentShufflesList: document.getElementById('recent-shuffles-list'),

            // Hand Analysis
            handAnalysisContainer: document.getElementById('hand-analysis-container'),
            openingHandRating: document.getElementById('opening-hand-rating'),
            openingHandAnalysisPoints: document.getElementById('opening-hand-analysis-points'),
            handInkableStat: document.getElementById('hand-inkable-stat'),
            handCurveStat: document.getElementById('hand-curve-stat'),
            handTypesStat: document.getElementById('hand-types-stat'),
            handColorsStat: document.getElementById('hand-colors-stat'),
            handCardImages: document.getElementById('hand-card-images'),
            handComparison: document.getElementById('hand-comparison'),

            // Early Game
            earlyInkableStat: document.getElementById('early-inkable-stat'),
            earlyCurveStat: document.getElementById('early-curve-stat'),
            earlyTypesStat: document.getElementById('early-types-stat'),
            earlyColorsStat: document.getElementById('early-colors-stat'),
            earlyTagsStat: document.getElementById('early-tags-stat'),

            // Timeline
            deckTimelineContainer: document.getElementById('deck-timeline-container'),
            deckTimelineHeader: document.getElementById('deck-timeline-header'),
            deckTimelineCards: document.getElementById('deck-timeline-cards'),

            // Shuffle Quality
            shuffleQualityContainer: document.getElementById('shuffle-quality-container'),
            shuffleQualityRating: document.getElementById('shuffle-quality-rating'),
            shuffleQualityIssues: document.getElementById('shuffle-quality-issues'),
            toggleStatsButton: document.getElementById('toggle-stats-button'),
            toggleStatsIcon: document.getElementById('toggle-stats-icon'),
            toggleStatsText: document.getElementById('toggle-stats-text'),
            detailedStatsContainer: document.getElementById('detailed-stats-container'),
            consecutiveCardsStat: document.getElementById('consecutive-cards-stat'),
            clusteringStat: document.getElementById('clustering-stat'),
            clusteringAlertBox: document.getElementById('clustering-alert-box'),
            clusteringAlertText: document.getElementById('clustering-alert-text'),
            distColorsStat: document.getElementById('dist-colors-stat'),
            distCostsStat: document.getElementById('dist-costs-stat'),
            distInkwellStat: document.getElementById('dist-inkwell-stat'),

            // Probabilities
            probabilityTableBody: document.getElementById('probability-table-body'),
            hyperDeckSize: document.getElementById('hyper-deck-size'),
            hyperCopies: document.getElementById('hyper-copies'),
            hyperHandSize: document.getElementById('hyper-hand-size'),
            hyperDesired: document.getElementById('hyper-desired'),
            hyperGte: document.getElementById('hyper-gte'),
            hyperEq: document.getElementById('hyper-eq'),
            hyperLt: document.getElementById('hyper-lt'),
        };

        // --- CONSTANTS ---
        const CARD_DATABASE_URL = "https://cdn.jsdelivr.net/gh/heavenideas/similcana@main/database/allCards.json";
        const ABILITIES_CONFIG_URL = "https://cdn.jsdelivr.net/gh/heavenideas/heavenideas.github.io@main/lorcanaUtils_MatchUpAnalyzer/lorcana_abilities_redux.json";
        const SUPABASE_URL = 'https://cjlhrfhximjldqrfblkj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqbGhyZmh4aW1qbGRxcmZibGtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MTcxNzQsImV4cCI6MjA2NTk5MzE3NH0.zLiQcPnKt2SnNfQIkUnOG7bOo6F7MPMh8MsasdFF6lw';
        const COLOR_MAP = {
            "Amber": "bg-amber-500",
            "Amethyst": "bg-purple-500",
            "Emerald": "bg-emerald-500",
            "Ruby": "bg-red-600",
            "Sapphire": "bg-blue-500",
            "Steel": "bg-gray-500"
        };
        const COLOR_HEX = {
            "Amber": "#f59e0b",
            "Amethyst": "#a855f7",
            "Emerald": "#10b981",
            "Ruby": "#dc2626",
            "Sapphire": "#3b82f6",
            "Steel": "#6b7280"
        };
        const RATING_CLASSES = {
            "Excellent": "text-green-400 border-green-700 bg-green-900",
            "Good": "text-blue-400 border-blue-700 bg-blue-900",
            "Average": "text-yellow-400 border-yellow-700 bg-yellow-900",
            "Poor": "text-red-400 border-red-700 bg-red-900",
            "Bad": "text-red-600 border-red-800 bg-red-950",
        };

        // --- INITIALIZATION ---
        window.onload = async () => {
            try {
                DOMElements.loadingMessage.textContent = "Loading Card Database...";
                const response = await fetch(CARD_DATABASE_URL);
                if (!response.ok) throw new Error(`Failed to fetch card database: ${response.statusText}`);
                const data = await response.json();
                allCardsData = data.cards;

                DOMElements.loadingMessage.textContent = "Loading Abilities Config...";
                // The library is loaded via <script> tag, so we just init it
                // We must provide the correct CDN URL for the JSON file
                await UnifiedWinProbabiliyCalculation.loadAbilitiesConfig(ABILITIES_CONFIG_URL);

                DOMElements.loadingMessage.textContent = "Initializing Modules...";
                CardStatAnalysisModule.initialize(allCardsData, COLOR_HEX, UnifiedWinProbabiliyCalculation);
                cardInspector = new CardThreatLevelInspector();

                DOMElements.loadingMessage.textContent = "Loading Decks...";
                await loadDecks();

                DOMElements.loadingMessage.textContent = "Ready!";
                DOMElements.loadingOverlay.style.display = 'none';
                DOMElements.loadDeckButton.disabled = false;
            } catch (error) {
                DOMElements.loadingMessage.textContent = "Failed to load critical data. Please refresh.";
                console.error("Initialization failed:", error);
            }
        };

        // --- EVENT LISTENERS ---
        DOMElements.deckSelect.addEventListener('change', handleDeckSelect);
        DOMElements.loadDeckButton.addEventListener('click', handleLoadDeck);
        DOMElements.shuffleButton.addEventListener('click', handleShuffleDeck);
        DOMElements.resetButton.addEventListener('click', handleReset);
        DOMElements.toggleStatsButton.addEventListener('click', toggleDetailedStats);

        const hyperInputs = [DOMElements.hyperDeckSize, DOMElements.hyperCopies, DOMElements.hyperHandSize, DOMElements.hyperDesired];
        hyperInputs.forEach(input => input.addEventListener('input', updateHypergeometricCalculator));

        // --- SUPABASE DECK LOADING ---
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function loadDecks() {
            try {
                const { data, error } = await supabaseClient.from('decks').select('*').order('created_at', { ascending: false });
                if (error) {
                    console.error('Error fetching decks:', error);
                    return;
                }
                allDecks = data || [];
                populateDeckSelect();
            } catch (error) {
                console.error('Failed to load decks:', error);
            }
        }

        function populateDeckSelect() {
            DOMElements.deckSelect.innerHTML = '<option value="">Select a deck...</option>';
            allDecks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = deck.name;
                DOMElements.deckSelect.appendChild(option);
            });
        }

        function handleDeckSelect() {
            const selectedId = DOMElements.deckSelect.value;
            if (!selectedId) return;
            const deck = allDecks.find(d => d.id == selectedId);
            if (deck) {
                DOMElements.decklistInput.value = deck.decklist;
                // Reset select
                DOMElements.deckSelect.value = '';
            }
        }

        // --- DECK LOADING & PARSING ---
        function handleLoadDeck() {
            const inputText = DOMElements.decklistInput.value;
            const { parsedDeck, parsedInfo, error } = parseDecklist(inputText);

            if (error) {
                DOMElements.deckLoadStatus.textContent = error;
                DOMElements.deckLoadStatus.classList.remove('text-green-500');
                DOMElements.deckLoadStatus.classList.add('text-red-500');
                return;
            }

            decklist = parsedDeck;
            deckInfo = parsedInfo;

            DOMElements.deckLoadStatus.textContent = `Deck loaded! (${deckInfo.totalCards} cards)`;
            DOMElements.deckLoadStatus.classList.remove('text-red-500');
            DOMElements.deckLoadStatus.classList.add('text-green-500');

            // Populate UI
            DOMElements.analyzerContent.classList.remove('opacity-50', 'pointer-events-none');
            DOMElements.hyperDeckSize.value = deckInfo.totalCards;
            populateProbabilityTable();
            populateDeckDistributionStats();
            handleReset(); // Clear any previous shuffle data
        }

        function parseDecklist(text) {
            let parsedDeck = [];
            let parsedInfo = {
                totalCards: 0,
                inkableCount: 0,
                colors: {},
                types: {},
                costs: {},
                byCopyCount: { 1: 0, 2: 0, 3: 0, 4: 0 }
            };
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const cardCounts = {};

            const lineRegex = /^(\d+)x?\s+(.*)$/i;

            for (const line of lines) {
                const match = line.trim().match(lineRegex);
                if (!match) continue;

                const quantity = parseInt(match[1], 10);
                const cardName = match[2].trim();

                // Find card in database
                const card = findCard(cardName);

                if (!card) {
                    return { error: `Error: Card not found "${cardName}"` };
                }

                // Add to decklist
                for (let i = 0; i < quantity; i++) {
                    parsedDeck.push(card);
                }

                // Update info
                cardCounts[card.id] = (cardCounts[card.id] || 0) + quantity;
                parsedInfo.totalCards += quantity;
                if (card.inkwell) parsedInfo.inkableCount += quantity;
                
                const cardColor = card.color.split('-')[0]; // Handle dual-ink
                parsedInfo.colors[cardColor] = (parsedInfo.colors[cardColor] || 0) + quantity;
                if (card.colors) { // Handle dual-ink second color
                     parsedInfo.colors[card.colors[1]] = (parsedInfo.colors[card.colors[1]] || 0) + quantity;
                }
                
                parsedInfo.types[card.type] = (parsedInfo.types[card.type] || 0) + quantity;
                parsedInfo.costs[card.cost] = (parsedInfo.costs[card.cost] || 0) + quantity;
            }
            
            // Calculate byCopyCount
            const counts = {};
            for (const card of parsedDeck) {
                counts[card.fullName] = (counts[card.fullName] || 0) + 1;
            }
            for (const count of Object.values(counts)) {
                if (count > 4) continue; // Ignore >4 copies
                parsedInfo.byCopyCount[count] = (parsedInfo.byCopyCount[count] || 0) + 1;
            }

            if (parsedDeck.length === 0) {
                return { error: "Error: No valid cards found in decklist." };
            }

            return { parsedDeck, parsedInfo, error: null };
        }

        function findCard(name) {
            const simpleName = s => s.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ');
            const searchName = simpleName(name);
            
            // Prioritize exact fullName match
            let found = allCardsData.find(c => c.fullName.toLowerCase() === name.toLowerCase());
            if (found) return found;

            // Fallback to simpleName match (handles "Mickey Mouse Brave Little Tailor")
            found = allCardsData.find(c => simpleName(c.fullName) === searchName);
            if (found) return found;

            // Fallback to name + version match
            found = allCardsData.find(c => c.name.toLowerCase() === name.toLowerCase() || c.simpleName === searchName);
            return found; // Might be ambiguous, but best effort
        }

        // --- SHUFFLE & ANALYSIS ---
        function handleShuffleDeck() {
            // 1. Shuffle
            shuffledDeck = fisherYatesShuffle([...decklist]);
            openingHand = shuffledDeck.slice(0, 7);

            // 2. Analyze
            currentShuffleAnalysis = analyzeShuffle(shuffledDeck);
            
            // 3. Add to Recent
            const shuffleEntry = {
                id: recentShuffles.length + 1,
                hand: openingHand,
                deck: shuffledDeck,
                analysis: currentShuffleAnalysis,
            };
            recentShuffles.unshift(shuffleEntry); // Add to beginning
            if (recentShuffles.length > 10) recentShuffles.pop(); // Limit history

            // 4. Render
            renderAll(shuffleEntry);
        }
        
        function handleReset() {
            shuffledDeck = [];
            openingHand = [];
            recentShuffles = [];
            currentShuffleAnalysis = {};
            
            // Clear UI
            DOMElements.handAnalysisContainer.classList.add('hidden');
            DOMElements.shuffleQualityContainer.classList.add('hidden');
            DOMElements.recentShufflesList.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">Shuffle the deck to see results.</p>';
            DOMElements.handQualityContainer.classList.add('hidden');
        }

        function fisherYatesShuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function analyzeShuffle(deck) {
            const analysis = {};
            const hand = deck.slice(0, 7);
            const earlyGame = deck.slice(0, 15);

            // Hand Analysis
            analysis.hand = analyzeCardGroup(hand);
            analysis.hand.quality = calculateHandQuality(analysis.hand);

            // Early Game Analysis
            analysis.earlyGame = analyzeCardGroup(earlyGame);

            // Shuffle Quality
            analysis.quality = analyzeDeckRandomness(deck);

            return analysis;
        }
        
        function analyzeCardGroup(cards) {
            const group = {
                cards: cards,
                count: cards.length,
                inkable: 0,
                avgCost: 0,
                costs: { "1-3": 0, "4-5": 0, "6+": 0 },
                types: {},
                colors: {},
                hasLowCost: false,
                hasHighCost: false,
            };

            let totalCost = 0;
            for (const card of cards) {
                if (card.inkwell) group.inkable++;
                totalCost += card.cost;
                
                if (card.cost <= 3) group.costs["1-3"]++;
                else if (card.cost <= 5) group.costs["4-5"]++;
                else group.costs["6+"]++;
                
                if (card.cost <= 2) group.hasLowCost = true;
                if (card.cost >= 5) group.hasHighCost = true;

                group.types[card.type] = (group.types[card.type] || 0) + 1;
                
                const cardColor = card.color.split('-')[0];
                group.colors[cardColor] = (group.colors[cardColor] || 0) + 1;
                if (card.colors) {
                    group.colors[card.colors[1]] = (group.colors[card.colors[1]] || 0) + 1;
                }
            }
            
            group.avgCost = group.count > 0 ? (totalCost / group.count) : 0;
            return group;
        }

        function calculateHandQuality(handStats) {
            let score = 0;

            // 1. Inkable Cards (Max 4 points)
            // Ideal is 3-5 inkable.
            const inkable = handStats.inkable;
            if (inkable === 3 || inkable === 4) score += 4;
            else if (inkable === 2 || inkable === 5) score += 3;
            else if (inkable === 1 || inkable === 6) score += 1;
            // 0 or 7 inkable gives 0 points for this.

            // 2. Early Curve (Max 6 points)
            // Ideal is having plays on T1, T2, T3.
            const earlyPlays = handStats.costs["1-3"];
            if (earlyPlays >= 3) score += 6;
            else if (earlyPlays === 2) score += 4;
            else if (earlyPlays === 1) score += 2;
            
            let rating = "Bad";
            if (score >= 9) rating = "Excellent";
            else if (score >= 7) rating = "Good";
            else if (score >= 5) rating = "Average";
            else if (score >= 3) rating = "Poor";

            return { score, rating };
        }
        
        function analyzeDeckRandomness(deck) {
            const quality = {};
            
            // 1. Consecutive Cards
            quality.consecutive = { 2: 0, 3: 0, 4: 0 };
            let consecutiveCount = 1;
            for (let i = 1; i < deck.length; i++) {
                if (deck[i].id === deck[i - 1].id) {
                    consecutiveCount++;
                } else {
                    if (consecutiveCount === 2) quality.consecutive[2]++;
                    else if (consecutiveCount === 3) quality.consecutive[3]++;
                    else if (consecutiveCount >= 4) quality.consecutive[4]++;
                    consecutiveCount = 1;
                }
            }
            // Check last run
            if (consecutiveCount === 2) quality.consecutive[2]++;
            else if (consecutiveCount === 3) quality.consecutive[3]++;
            else if (consecutiveCount >= 4) quality.consecutive[4]++;

            // 2. Clustering
            quality.clusters = {
                color: findClusters(deck, c => c.color),
                cost: findClusters(deck, c => c.cost),
                type: findClusters(deck, c => c.type),
                inkless: findClusters(deck, c => !c.inkwell),
            };
            
            // 3. Overall Rating & Issues
            quality.issues = [];
            if (quality.consecutive[3] > 0) quality.issues.push(`• ${quality.consecutive[3]} instance(s) of 3 same cards in a row.`);
            if (quality.consecutive[4] > 0) quality.issues.push(`• ${quality.consecutive[4]} instance(s) of 4+ same cards in a row.`);
            if (quality.clusters.color.max > 5) quality.issues.push(`• ${quality.clusters.color.max} cards of same color in a row.`);
            if (quality.clusters.inkless.max > 3) quality.issues.push(`• ${quality.clusters.inkless.max} inkless cards in a row.`);
            
            if (quality.issues.length === 0) {
                quality.rating = "Excellent";
                quality.issues.push("✓ No critical issues detected. Cards are well-distributed.");
            } else if (quality.issues.length <= 2) {
                quality.rating = "Good";
            } else {
                quality.rating = "Poor";
            }
            
            return quality;
        }
        
        function findClusters(deck, getProperty) {
            let maxCluster = 0;
            let currentCluster = 1;
            let clusterCount = 0;
            
            if (deck.length === 0) return { max: 0, count: 0 };
            
            let lastProp = getProperty(deck[0]);
            
            for (let i = 1; i < deck.length; i++) {
                const currentProp = getProperty(deck[i]);
                if (currentProp === lastProp) {
                    currentCluster++;
                } else {
                    if (currentCluster > 1) clusterCount++;
                    maxCluster = Math.max(maxCluster, currentCluster);
                    currentCluster = 1;
                    lastProp = currentProp;
                }
            }
            // Check last run
            if (currentCluster > 1) clusterCount++;
            maxCluster = Math.max(maxCluster, currentCluster);
            
            return { max: maxCluster, count: clusterCount };
        }

        // --- UI RENDERING ---
        function renderAll(shuffleEntry) {
            DOMElements.handAnalysisContainer.classList.remove('hidden');
            DOMElements.shuffleQualityContainer.classList.remove('hidden');
            DOMElements.handQualityContainer.classList.remove('hidden');

            const { analysis } = shuffleEntry;

            // 1. Render Shuffle Sim
            renderShuffleSimulator(shuffleEntry);
            renderRecentShuffles();
            
            // 2. Render Hand Analysis
            renderHandAnalysis(analysis.hand, analysis.earlyGame);
            renderCardImages(DOMElements.handCardImages, shuffleEntry.hand);
            
            // 3. Render Early Game
            renderEarlyGame(analysis.earlyGame);
            
            // 4. Render Timeline
            renderDeckTimeline(shuffleEntry.deck.slice(7));
            
            // 5. Render Shuffle Quality
            renderShuffleQuality(analysis.quality);
        }
        
        function renderShuffleSimulator(entry) {
            const { score, rating } = entry.analysis.hand.quality;
            DOMElements.handQualityScore.innerHTML = `${score.toFixed(1)}<span class="text-lg text-gray-500">/10</span>`;
            DOMElements.handQualityRating.textContent = rating;
            DOMElements.handQualityRating.className = `inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold ${RATING_CLASSES[rating]}`;
            DOMElements.handQualityBar.style.width = `${score * 10}%`;
        }
        
        function renderRecentShuffles() {
            DOMElements.recentShufflesList.innerHTML = '';
            recentShuffles.forEach((entry, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `w-full text-left px-3 py-2 rounded-lg border transition-colors ${index === 0 ? 'border-blue-500 bg-blue-900 bg-opacity-30' : 'border-gray-700 hover:bg-gray-700'}`;
                button.onclick = () => renderAll(entry);
                button.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="inline-flex items-center rounded-md border border-gray-600 bg-gray-800 px-2.5 py-0.5 text-xs text-white">#${entry.id}</div>
                            ${index === 0 ? '<span class="text-xs text-blue-400 font-medium">Current</span>' : ''}
                        </div>
                        <span class="text-xs ${index === 0 ? 'text-blue-400' : 'text-gray-500'}">${entry.analysis.hand.quality.rating} (${entry.analysis.hand.quality.score.toFixed(1)})</span>
                    </div>
                `;
                DOMElements.recentShufflesList.appendChild(button);
            });
        }
        
        function renderHandAnalysis(hand, early) {
            const { rating } = hand.quality;
            DOMElements.openingHandRating.textContent = rating;
            DOMElements.openingHandRating.className = `inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold ${RATING_CLASSES[rating]}`;

            // Analysis Points
            const points = [
                { ok: hand.inkable >= 2 && hand.inkable <= 5, text: `Inkable: ${hand.inkable} (Ideal 2-5)` },
                { ok: hand.costs["1-3"] > 0, text: `Early Plays (1-3): ${hand.costs["1-3"]}` },
                { ok: hand.costs["6+"] <= 2, text: `High Cost (6+): ${hand.costs["6+"]} (Ideal <= 2)` },
                { ok: hand.avgCost < 4.0, text: `Avg Cost: ${hand.avgCost.toFixed(1)}` }
            ];
            DOMElements.openingHandAnalysisPoints.innerHTML = points.map(p => 
                `<p class="text-sm ${p.ok ? 'text-green-400' : 'text-yellow-400'}">${p.ok ? '✓' : '⚠'} ${p.text}</p>`
            ).join('');
            
            // Stats
            DOMElements.handInkableStat.textContent = `${hand.inkable} out of 7`;
            DOMElements.handCurveStat.innerHTML = Object.entries(hand.costs).map(([key, val]) => createTag(`T${key}: ${val}`)).join('');
            DOMElements.handTypesStat.innerHTML = Object.entries(hand.types).map(([key, val]) => createTag(`${key}: ${val}`)).join('');
            DOMElements.handColorsStat.innerHTML = Object.entries(hand.colors).map(([key, val]) => createTag(`${key}: ${val}`, COLOR_HEX[key])).join('');
            
            // Comparison
            let comparisonHTML = '';
            if (hand.inkable / 7 > deckInfo.inkableCount / deckInfo.totalCards) {
                comparisonHTML += `<span class="inline-flex items-center gap-1 text-green-400">↑ More inkable than average</span>`;
            } else {
                comparisonHTML += `<span class="inline-flex items-center gap-1 text-red-400">↓ Less inkable than average</span>`;
            }
            DOMElements.handComparison.innerHTML = comparisonHTML;
        }
        
        function renderEarlyGame(early) {
            DOMElements.earlyInkableStat.textContent = `${early.inkable} out of 15`;
            DOMElements.earlyCurveStat.innerHTML = Object.entries(early.costs).map(([key, val]) => createTag(`T${key}: ${val}`)).join('');
            DOMElements.earlyTypesStat.innerHTML = Object.entries(early.types).map(([key, val]) => createTag(`${key}: ${val}`)).join('');
            DOMElements.earlyColorsStat.innerHTML = Object.entries(early.colors).map(([key, val]) => createTag(`${key}: ${val}`, COLOR_HEX[key])).join('');
            
            let tags = [];
            if(early.hasLowCost) tags.push(createTag('✓ Has Low Costs (1-2)', null, 'bg-gray-700 text-gray-300'));
            if(early.hasHighCost) tags.push(createTag('⚠ Has High Costs (5+)', null, 'bg-gray-700 text-gray-300'));
            DOMElements.earlyTagsStat.innerHTML = tags.join('');
        }
        
        function renderCardImages(container, cards) {
            container.innerHTML = '';
            cards.forEach((card, index) => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'space-y-0.5 max-w-32 relative';
                cardWrapper.innerHTML = `
                    <div class="relative card-tooltip-trigger">
                        <div class="aspect-[2/3] relative rounded border border-gray-700 overflow-hidden cursor-help transition-all hover:border-blue-500">
                            <img alt="${card.fullName}" class="w-full h-full object-cover" loading="lazy" src="${card.images.thumbnail}">
                        </div>
                    </div>
                    <p class="text-[0.6rem] text-center text-gray-500">#${index + 1}</p>
                    <div class="card-tooltip w-48">
                        <img alt="${card.fullName}" class="w-full h-full rounded-lg" src="${card.images.full}">
                    </div>
                `;
                container.appendChild(cardWrapper);
            });

            // Add click handlers for card inspection
            let cardIndex = 0;
            container.querySelectorAll('img').forEach((img) => {
                if (img.closest('.card-tooltip')) return; // skip tooltip imgs
                const card = cards[cardIndex];
                img.style.cursor = 'pointer';
                img.addEventListener('click', () => {
                    if (cardInspector && card) {
                        try {
                            cardInspector.showCard(card);
                        } catch (error) {
                            console.error('Error opening card inspector:', error, card);
                        }
                    }
                });
                cardIndex++;
            });
        }
        
        function renderDeckTimeline(deck) {
            DOMElements.deckTimelineHeader.textContent = `Deck Timeline (${deck.length} cards)`;
            DOMElements.deckTimelineCards.innerHTML = '';
            deck.forEach((card, index) => {
                const turn = index + 1; // Turn 1 is first draw
                let borderColor = 'border-blue-500'; // Early
                if (turn >= 8 && turn <= 14) borderColor = 'border-yellow-500'; // Mid
                else if (turn >= 15) borderColor = 'border-purple-500'; // Late
                
                const cardHTML = `
                    <div class="flex-shrink-0 space-y-2 ${turn === 8 || turn === 15 ? `border-l-4 pl-3 ${borderColor}` : ''}">
                        <div class="text-center"><p class="text-xs font-semibold text-gray-500">Turn ${turn}</p></div>
                        <div class="relative card-tooltip-trigger">
                            <div class="w-24 space-y-1">
                                <div class="aspect-[2/3] relative rounded border border-gray-700 overflow-hidden cursor-help transition-all hover:border-blue-500">
                                    <img alt="${card.fullName}" class="w-full h-full object-cover" loading="lazy" src="${card.images.thumbnail}">
                                </div>
                                <p class="text-[0.65rem] text-center font-medium line-clamp-2 text-white">${card.name}</p>
                                <p class="text-[0.55rem] text-center text-gray-500">#${index + 8}</p>
                            </div>
                            <div class="card-tooltip w-64">
                                <img alt="${card.fullName}" class="w-full h-full rounded-lg" src="${card.images.full}">
                            </div>
                        </div>
                    </div>
                `;
                DOMElements.deckTimelineCards.innerHTML += cardHTML;
            });

            // Add click handlers for timeline cards
            let cardIndex = 0;
            DOMElements.deckTimelineCards.querySelectorAll('img').forEach((img) => {
                if (img.closest('.card-tooltip')) return; // skip tooltip imgs
                const card = deck[cardIndex];
                img.style.cursor = 'pointer';
                img.addEventListener('click', () => {
                    if (cardInspector && card) {
                        try {
                            cardInspector.showCard(card);
                        } catch (error) {
                            console.error('Error opening card inspector:', error, card);
                        }
                    }
                });
                cardIndex++;
            });
        }
        
        function renderShuffleQuality(quality) {
            DOMElements.shuffleQualityRating.textContent = quality.rating;
            DOMElements.shuffleQualityRating.className = `inline-flex items-center rounded-full border px-2.5 py-0.5 text-sm font-semibold ${RATING_CLASSES[quality.rating]}`;
            
            DOMElements.shuffleQualityIssues.innerHTML = quality.issues.map(issue => {
                const isGood = issue.startsWith('✓');
                return `<p class="${isGood ? 'text-green-400' : 'text-yellow-400'} flex items-center gap-2"><span>${isGood ? '✓' : '⚠'}</span><span>${issue.substring(2)}</span></p>`;
            }).join('');
            
            // Stats
            DOMElements.consecutiveCardsStat.innerHTML = `
                <div class="flex justify-between"><span>2 in a row:</span>${createTag(quality.consecutive[2], null, quality.consecutive[2] > 2 ? RATING_CLASSES['Poor'] : 'bg-gray-700 text-gray-300')}</div>
                <div class="flex justify-between"><span>3 in a row:</span>${createTag(quality.consecutive[3], null, quality.consecutive[3] > 0 ? RATING_CLASSES['Poor'] : 'bg-gray-700 text-gray-300')}</div>
                <div class="flex justify-between"><span>4+ in a row:</span>${createTag(quality.consecutive[4], null, quality.consecutive[4] > 0 ? RATING_CLASSES['Bad'] : 'bg-gray-700 text-gray-300')}</div>
            `;
            
            DOMElements.clusteringStat.innerHTML = `
                <div class="space-y-1"><span class="text-gray-500">Color Clusters:</span><div class="flex items-center gap-2">${createTag(`Max: ${quality.clusters.color.max}`, null, quality.clusters.color.max > 5 ? RATING_CLASSES['Poor'] : 'bg-gray-700 text-gray-300')}<span class="text-gray-500">(${quality.clusters.color.count} clusters)</span></div></div>
                <div class="space-y-1"><span class="text-gray-500">Cost Clusters:</span><div class="flex items-center gap-2">${createTag(`Max: ${quality.clusters.cost.max}`, null, 'bg-gray-700 text-gray-300')}<span class="text-gray-500">(${quality.clusters.cost.count} clusters)</span></div></div>
                <div class="space-y-1"><span class="text-gray-500">Type Clusters:</span><div class="flex items-center gap-2">${createTag(`Max: ${quality.clusters.type.max}`, null, quality.clusters.type.max > 7 ? RATING_CLASSES['Poor'] : 'bg-gray-700 text-gray-300')}<span class="text-gray-500">(${quality.clusters.type.count} clusters)</span></div></div>
                <div class="space-y-1"><span class="text-gray-500">Inkless Clusters:</span><div class="flex items-center gap-2">${createTag(`Max: ${quality.clusters.inkless.max}`, null, quality.clusters.inkless.max > 3 ? RATING_CLASSES['Poor'] : 'bg-gray-700 text-gray-300')}<span class="text-gray-500">(${quality.clusters.inkless.count} clusters)</span></div></div>
            `;
            
            // Alert Box
            const alerts = quality.issues.filter(i => !i.startsWith('✓'));
            if (alerts.length > 0) {
                DOMElements.clusteringAlertBox.classList.remove('hidden');
                DOMElements.clusteringAlertText.innerHTML = `<div>Large clusters detected:</div><ul class="list-disc pl-4">${alerts.map(a => `<li>${a.substring(2)}</li>`).join('')}</ul>`;
            } else {
                DOMElements.clusteringAlertBox.classList.add('hidden');
            }
        }
        
        function populateDeckDistributionStats() {
            DOMElements.distColorsStat.innerHTML = Object.entries(deckInfo.colors).map(([key, val]) => createTag(`${key}: ${val}`, COLOR_HEX[key])).join('');
            DOMElements.distCostsStat.innerHTML = Object.entries(deckInfo.costs).sort((a,b) => a[0] - b[0]).map(([key, val]) => createTag(`${key}: ${val}`)).join('');
            DOMElements.distInkwellStat.innerHTML = `${createTag(`Inkable: ${deckInfo.inkableCount}`)} ${createTag(`Inkless: ${deckInfo.totalCards - deckInfo.inkableCount}`)}`;
        }

        function toggleDetailedStats() {
            const isHidden = DOMElements.detailedStatsContainer.classList.toggle('hidden');
            if (isHidden) {
                DOMElements.toggleStatsText.textContent = "Show Detailed Statistics";
                DOMElements.toggleStatsIcon.style.transform = "rotate(0deg)";
            } else {
                DOMElements.toggleStatsText.textContent = "Hide Detailed Statistics";
                DOMElements.toggleStatsIcon.style.transform = "rotate(180deg)";
            }
        }

        // --- PROBABILITY CALCULATORS ---
        function combinations(n, k) {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            if (k > n / 2) k = n - k;
            
            const cacheKey = `${n},${k}`;
            if (combinationsCache[cacheKey]) return combinationsCache[cacheKey];

            let res = 1;
            for (let i = 1; i <= k; i++) {
                res = res * (n - i + 1) / i;
            }
            
            combinationsCache[cacheKey] = res;
            return res;
        }

        function hypergeometricProbability(N, k, n, x) {
            const C_kx = combinations(k, x);
            const C_Nknx = combinations(N - k, n - x);
            const C_Nn = combinations(N, n);
            if (C_Nn === 0) return 0;
            return (C_kx * C_Nknx) / C_Nn;
        }
        
        function updateHypergeometricCalculator() {
            const N = parseInt(DOMElements.hyperDeckSize.value, 10);
            const k = parseInt(DOMElements.hyperCopies.value, 10);
            const n = parseInt(DOMElements.hyperHandSize.value, 10);
            const x = parseInt(DOMElements.hyperDesired.value, 10);

            if ([N, k, n, x].some(isNaN)) {
                DOMElements.hyperGte.textContent = '...';
                DOMElements.hyperEq.textContent = '...';
                DOMElements.hyperLt.textContent = '...';
                return;
            }

            let p_gte = 0;
            for (let i = x; i <= Math.min(n, k); i++) {
                p_gte += hypergeometricProbability(N, k, n, i);
            }
            
            let p_eq = (x > Math.min(n,k)) ? 0 : hypergeometricProbability(N, k, n, x);
            let p_lt = 1 - p_gte;

            DOMElements.hyperGte.textContent = (p_gte * 100).toFixed(1) + '%';
            DOMElements.hyperEq.textContent = (p_eq * 100).toFixed(1) + '%';
            DOMElements.hyperLt.textContent = (p_lt * 100).toFixed(1) + '%';
        }

        function populateProbabilityTable() {
            const N = deckInfo.totalCards;
            const n = 7; // Opening hand size
            DOMElements.probabilityTableBody.innerHTML = '';
            
            const categories = [];
            
            // Colors
            Object.entries(deckInfo.colors).forEach(([name, count]) => {
                categories.push({ name: name, count: count, color: COLOR_HEX[name] });
            });
            categories.push({ separator: true });
            
            // Inkable/Inkless
            categories.push({ name: 'Inkable', count: deckInfo.inkableCount });
            categories.push({ name: 'Inkless', count: N - deckInfo.inkableCount });
            categories.push({ separator: true });

            // Types
            Object.entries(deckInfo.types).forEach(([name, count]) => {
                categories.push({ name: `${name}s`, count: count });
            });
            categories.push({ separator: true });
            
            // By Copy Count
            Object.entries(deckInfo.byCopyCount).forEach(([name, count]) => {
                 if(count > 0) categories.push({ name: `Cards with ${name} ${name > 1 ? 'copies' : 'copy'}`, count: count * parseInt(name) });
            });

            // Calculate probs for each category
            categories.forEach(cat => {
                if (cat.separator) {
                    DOMElements.probabilityTableBody.innerHTML += `<tr class="border-b border-gray-700 bg-gray-700 bg-opacity-30"><td class="p-4 h-2" colspan="6"></td></tr>`;
                    return;
                }
                
                const k = cat.count;
                const p = [0, 0, 0, 0, 0]; // 0, 1, 2, 3, 4+
                let p_total = 0;
                
                for (let x = 0; x <= Math.min(n, k); x++) {
                    const prob = hypergeometricProbability(N, k, n, x);
                    if (x <= 2) {
                        p[x] = prob;
                    } else if (x === 3) {
                        p[3] = prob;
                    } else {
                        p[4] += prob;
                    }
                    p_total += prob;
                }
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 transition-colors';
                row.innerHTML = `
                    <td class="p-4 align-middle font-medium">
                        <div class="flex items-center gap-2">
                            ${cat.color ? `<div class="w-3 h-3 rounded-full" style="background-color: ${cat.color};"></div>` : ''}
                            <span>${cat.name}</span>
                            <span class="text-xs text-gray-500">(${k})</span>
                        </div>
                    </td>
                    ${p.map(val => `<td class="p-4 align-middle text-center">${(val * 100).toFixed(0)}%</td>`).join('')}
                `;
                DOMElements.probabilityTableBody.appendChild(row);
            });
            
            // Init hypercalc
            updateHypergeometricCalculator();
        }

        // --- UI HELPERS ---
        function createTag(text, color = null, baseClass = 'bg-gray-800 border-gray-700 text-gray-300') {
            let style = '';
            if (color) {
                // A bit of opacity for colored tags
                style = `background-color: ${color}33; border-color: ${color}99; color: ${color};`;
                baseClass = ''; // Override base class
            }
            return `<div class="inline-flex items-center rounded-md border-2 ${baseClass} px-2 py-0.5 text-xs font-semibold" style="${style}">${text}</div>`;
        }

    </script>
</body>
</html>