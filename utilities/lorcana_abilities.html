<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorcana Ability Editor & Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.basic.min.js"></script>
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .highlight {
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #1e293b; /* slate-800 */
        }
        
        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }

        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        .pattern-highlight {
            background-color: #1e3a8a !important; /* blue-900 */
            border-left-width: 4px;
            border-color: #3b82f6; /* blue-500 */
        }

        .form-input, .form-textarea {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #1e40af; /* blue-800 */
        }

        .form-textarea-auto {
            min-height: 42px; /* Match input height */
            resize: none;
            overflow-y: hidden;
        }
        
        .form-label {
            font-weight: 500;
            color: #94a3b8; /* slate-400 */
            margin-bottom: 0.25rem;
            display: block;
            font-size: 0.875rem;
        }

        .regex-input {
            font-family: monospace;
            font-size: 0.875rem;
            color: #f472b6; /* pink-400 */
        }
        
        .regex-input-error {
            border: 2px solid #ef4444 !important; /* red-500 */
        }

        @keyframes focus-highlight {
            from { background-color: #2563eb; } /* blue-600 */
            to { background-color: #1e293b; } /* slate-800 */
        }

        .focus-animation {
            animation: focus-highlight 1.5s ease-out;
        }

        .tree-nav-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .tree-nav-item:hover {
            background-color: #334155; /* slate-700 */
        }
        .tree-nav-item.active {
            background-color: #2563eb; /* blue-600 */
            color: #f1f5f9; /* slate-100 */
        }
        .tree-nav-item.subtype {
            padding-left: 28px;
            font-size: 0.9rem;
            font-weight: 400;
        }
        .tree-nav-item .count {
            font-size: 0.8rem;
            color: #94a3b8; /* slate-400 */
            margin-left: 8px;
        }
        .tree-nav-item.active .count {
            color: #dbeafe; /* blue-200 */
        }

        /* Sort Indicators */
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            transition: border-color 0.2s;
        }

        .sort-indicator.asc {
            border-bottom: 6px solid #64748b; /* slate-500 */
        }

        .sort-indicator.desc {
            border-top: 6px solid #64748b; /* slate-500 */
        }

        /* Splitter Styles */
        .gutter {
            background-color: #0f172a; /* slate-950 */
        }
        .gutter.gutter-horizontal {
            cursor: col-resize;
        }
        .gutter.gutter-horizontal::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 50px;
            background-color: #334155; /* slate-700 */
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .gutter.gutter-horizontal:hover::before {
            background-color: #475569; /* slate-600 */
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-300">

    <div id="app" class="min-h-screen w-screen p-4 md:p-6 flex flex-col">
        <header class="text-center mb-6 border-b border-slate-800 pb-6 flex-shrink-0">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-100">Lorcana Ability Editor & Analyzer</h1>
            <p class="text-slate-400 mt-2">Load, edit, and analyze ability patterns across all Disney Lorcana cards.</p>
        </header>

        <div id="loader" class="text-center py-10 flex-grow flex items-center justify-center">
            <div class="flex justify-center items-center space-x-2">
                <svg class="animate-spin h-8 w-8 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-lg font-medium text-slate-400">Loading card database...</span>
            </div>
        </div>
        
        <div id="warning-banner" class="hidden bg-yellow-900/50 border border-yellow-700 text-yellow-200 px-4 py-3 rounded-lg mb-6 text-center"></div>

        <main id="main-content" class="hidden flex-grow lg:overflow-hidden">
            <div id="split-container" class="flex flex-col lg:flex-row w-full h-full gap-4 lg:gap-0">
                
                <!-- Left Column: Ability Editor -->
                <div id="left-pane" class="bg-slate-900 p-4 rounded-2xl shadow-lg flex flex-col lg:overflow-hidden">
                    <h2 id="toggle-editor-section" class="text-2xl font-bold mb-4 text-slate-100 border-b border-slate-700 pb-3 flex justify-between items-center lg:cursor-default cursor-pointer">
                        <span>Ability Pattern Editor</span>
                        <svg id="editor-section-chevron" class="w-6 h-6 transition-transform transform lg:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </h2>
                    
                    <!-- Controls -->
                    <div class="flex flex-wrap gap-4 items-center mb-4">
                        <div class="flex-grow">
                            <label for="json-file-input" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition cursor-pointer">Load lorcana_abilities.json</label>
                            <input type="file" id="json-file-input" class="hidden" accept=".json">
                        </div>
                        <div class="flex gap-2">
                            <button id="edit-mode-btn" class="px-3 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition">Edit Mode</button>
                            <button id="view-mode-btn" class="px-3 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 transition">View Mode</button>
                        </div>
                        <button id="save-json-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">Save JSON</button>
                        <button id="new-ability-btn" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 transition">New Ability</button>
                        <button id="edit-constants-btn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">Edit Constants</button>
                        <button id="save-md-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">Save Markdown</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="relative flex-grow">
                             <input type="text" id="pattern-filter-input" placeholder="Filter abilities by name..." class="form-input w-full !pl-10">
                             <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <label for="sort-select" class="text-sm text-slate-400 whitespace-nowrap">Sort by:</label>
                            <div class="relative">
                                <select id="sort-select" class="form-input text-sm w-40 pr-8">
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                    <option value="category-asc">Category (A-Z)</option>
                                    <option value="category-desc">Category (Z-A)</option>
                                    <option value="subtype-asc">Sub-type (A-Z)</option>
                                    <option value="subtype-desc">Sub-type (Z-A)</option>
                                    <option value="recent">Recently Modified</option>
                                    <option value="regex-length">Regex Length</option>
                                </select>
                                <div id="sort-indicator" class="sort-indicator asc absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"></div>
                            </div>
                        </div>
                        <span id="last-loaded-timestamp" class="text-xs text-slate-500 ml-4 whitespace-nowrap"></span>
                    </div>

                    <!-- Main Content Area -->
                    <div id="editor-content-wrapper" class="flex-grow flex gap-4 overflow-hidden transition-all duration-500 ease-in-out">
                        <!-- Tree Navigation -->
                        <div id="tree-nav-container" class="w-1/3 bg-slate-950 p-3 rounded-lg overflow-y-auto">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-slate-200">Navigation</h3>
                                <div class="flex gap-2">
                                    <button id="nav-names-btn" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition">Names</button>
                                    <button id="nav-categories-btn" class="px-2 py-1 text-xs bg-slate-600 text-white rounded hover:bg-slate-700 transition">Categories</button>
                                </div>
                            </div>
                            <div id="tree-nav">
                                <div class="text-center text-slate-500 text-sm py-6">Load a file to build navigation.</div>
                            </div>
                        </div>

                        <!-- Pattern List -->
                        <div id="pattern-list" class="space-y-4 overflow-y-auto flex-grow pr-2 w-2/3">
                             <div id="pattern-placeholder" class="text-center text-slate-500 py-10 border-2 border-dashed border-slate-700 rounded-lg">
                                <p>Load `lorcana_abilities.json` to start editing.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Card Analyzer -->
                <div id="right-pane" class="bg-slate-900 p-4 rounded-2xl shadow-lg flex flex-col lg:overflow-hidden">
                    <div id="card-search-container" class="flex flex-col overflow-hidden">
                        <h2 id="toggle-card-search-section" class="text-2xl font-bold text-slate-100 border-b border-slate-700 pb-3 flex justify-between items-center cursor-pointer flex-shrink-0">
                            <span>Card Search & Analysis</span>
                            <svg id="card-search-chevron" class="w-6 h-6 transition-transform transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </h2>
                        <div id="card-search-wrapper" class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-500 ease-in-out overflow-hidden">
                            <div class="overflow-hidden flex flex-col min-h-0">
                                <div class="relative mt-4">
                                    <input type="text" id="search-input" placeholder="Search for a card (e.g., 'Elsa', 'Be Prepared')" class="form-input w-full">
                                    <div id="search-results" class="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                                </div>
                                <div id="card-display" class="mt-4 overflow-y-auto flex-grow pr-2">
                                    <div id="card-placeholder" class="text-center text-slate-500 py-10 border-2 border-dashed border-slate-700 rounded-lg">
                                        <p>Select a card to see its ability analysis.</p>
                                        <p class="text-sm mt-1">Edits to abilities on the left will update the analysis here live.</p>
                                    </div>
                                    <div id="card-details" class="hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Regex Search -->
                    <div id="custom-regex-section" class="mt-4 p-4 bg-slate-950 rounded-xl border border-slate-800 flex flex-col">
                        <h3 id="toggle-regex-section" class="text-lg font-bold text-slate-100 mb-2 flex justify-between items-center cursor-pointer flex-shrink-0">
                            <span>Custom Regex Card Search</span>
                            <svg id="regex-section-chevron" class="w-5 h-5 transition-transform transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                            </svg>
                        </h3>
                        <div id="custom-regex-content" class="transition-all duration-500 ease-in-out overflow-hidden max-h-0 flex-grow flex flex-col">
                            <div class="flex flex-col md:flex-row gap-4 items-start md:items-end pt-2">
                                <div class="flex-1">
                                    <label for="custom-regex-input" class="form-label">Regex Pattern</label>
                                    <input type="text" id="custom-regex-input" class="form-input regex-input" placeholder="e.g. draw 2 cards" />
                                </div>
                                <div>
                                    <label for="custom-regex-flags" class="form-label">Flags</label>
                                    <input type="text" id="custom-regex-flags" class="form-input regex-input w-20" placeholder="gi" value="gi" />
                                </div>
                                <button id="custom-regex-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition w-full md:w-auto">Search</button>
                                <button id="copy-results-btn" class="px-5 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition w-full md:w-auto hidden">Copy Names & Abilities</button>
                            </div>
                            <div class="mt-4 flex items-center space-x-4">
                                <label class="form-label !mb-0">Filter by Format:</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="format-filter-core" name="format-filter" value="Core" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 bg-slate-700 border-slate-600">
                                    <label for="format-filter-core" class="ml-2 block text-sm text-slate-300">Core</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="format-filter-infinity" name="format-filter" value="Infinity" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 bg-slate-700 border-slate-600">
                                    <label for="format-filter-infinity" class="ml-2 block text-sm text-slate-300">Infinity</label>
                                </div>
                            </div>
                            <div id="custom-regex-error" class="text-red-500 text-sm mt-2 hidden"></div>
                            <div id="custom-regex-stats" class="mt-4 text-sm text-slate-400"></div>
                            <div id="custom-regex-results" class="mt-4 overflow-auto pr-2 flex-grow min-h-[50vh]"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Constants Editor Modal -->
        <div id="constants-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-xl w-full max-w-2xl p-6 m-4 flex flex-col max-h-full">
                <div class="flex-shrink-0">
                    <h2 class="text-2xl font-bold text-slate-100 mb-4">Edit Constants</h2>
                    <p class="text-slate-400 mb-4">Edit the JSON for the @constants object. Be careful with the structure.</p>
                </div>
                <div class="flex-grow overflow-y-auto pr-2">
                    <textarea id="constants-textarea" class="form-input form-textarea w-full h-full font-mono text-sm" style="min-height: 300px;"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4 flex-shrink-0">
                    <button id="cancel-constants-btn" class="px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition">Cancel</button>
                    <button id="save-constants-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Save Constants</button>
                </div>
            </div>
        </div>
    </div>

    <script src="unified_win_probability_utilities.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SPLIT PANE LOGIC ---
            let split = null;
            const setupSplitView = () => {
                const splitContainer = document.getElementById('split-container');
                if (window.innerWidth >= 1024) { // Tailwind's lg breakpoint
                    if (!split) {
                        // Ensure horizontal layout for split view
                        splitContainer.classList.remove('flex-col', 'gap-4');
                        splitContainer.classList.add('flex-row');
                        
                        split = Split(['#left-pane', '#right-pane'], {
                            sizes: [50, 50],
                            minSize: 400,
                            gutterSize: 12,
                            elementStyle: (dimension, size, gutterSize) => ({
                                'flex-basis': `calc(${size}% - ${gutterSize}px)`,
                            }),
                            gutterStyle: (dimension, gutterSize) => ({
                                'flex-basis': `${gutterSize}px`,
                            }),
                        });
                    }
                } else {
                    if (split) {
                        split.destroy(true);
                        split = null;
                    }
                    // Ensure vertical layout for mobile
                    splitContainer.classList.remove('flex-row');
                    splitContainer.classList.add('flex-col', 'gap-4');
                }
            };

            // --- GLOBAL STATE ---
            let allCards = [];
            let ABILITIES_CONFIG = { '@constants': {}, abilities: [] };
            let fuse;
            let abilityFuse;
            let selectedCard = null;
            let lastRegexResults = [];
            let currentSort = 'name-asc'; // Default sort
            let sortDirection = 'asc';
            let sortField = 'name';
            let navMode = 'names'; // Default to names view
            let displayMode = 'edit'; // Default to edit mode

            const DB_URL = 'https://raw.githubusercontent.com/heavenideas/similcana/refs/heads/main/database/allCards.json';

            // --- UI ELEMENTS ---
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const warningBanner = document.getElementById('warning-banner');
            
            // Left Column
            const jsonFileInput = document.getElementById('json-file-input');
            const saveJsonBtn = document.getElementById('save-json-btn');
            const saveMdBtn = document.getElementById('save-md-btn');
            const newAbilityBtn = document.getElementById('new-ability-btn');
            const patternFilterInput = document.getElementById('pattern-filter-input');
            const sortSelect = document.getElementById('sort-select');
            const navNamesBtn = document.getElementById('nav-names-btn');
            const navCategoriesBtn = document.getElementById('nav-categories-btn');
            const editModeBtn = document.getElementById('edit-mode-btn');
            const viewModeBtn = document.getElementById('view-mode-btn');
            const patternListContainer = document.getElementById('pattern-list');
            const patternPlaceholder = document.getElementById('pattern-placeholder');
            const lastLoadedTimestamp = document.getElementById('last-loaded-timestamp');
            const treeNavContainer = document.getElementById('tree-nav');

            // Right Column
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const cardDetailsContainer = document.getElementById('card-details');
            const cardPlaceholder = document.getElementById('card-placeholder');
            const cardSearchContainer = document.getElementById('card-search-container');
            const toggleCardSearchSection = document.getElementById('toggle-card-search-section');
            const cardSearchWrapper = document.getElementById('card-search-wrapper');
            const cardSearchChevron = document.getElementById('card-search-chevron');
            const customRegexInput = document.getElementById('custom-regex-input');
            const customRegexFlags = document.getElementById('custom-regex-flags');
            const customRegexBtn = document.getElementById('custom-regex-btn');
            const customRegexResults = document.getElementById('custom-regex-results');
            const customRegexError = document.getElementById('custom-regex-error');
            const customRegexStats = document.getElementById('custom-regex-stats');
            const copyResultsBtn = document.getElementById('copy-results-btn');
            const toggleRegexSection = document.getElementById('toggle-regex-section');
            const customRegexContent = document.getElementById('custom-regex-content');
            const regexSectionChevron = document.getElementById('regex-section-chevron');
            const toggleEditorSection = document.getElementById('toggle-editor-section');
            const editorContentWrapper = document.getElementById('editor-content-wrapper');
            const editorSectionChevron = document.getElementById('editor-section-chevron');
 
             // Constants Modal
             const editConstantsBtn = document.getElementById('edit-constants-btn');
            const constantsModal = document.getElementById('constants-modal');
            const constantsTextarea = document.getElementById('constants-textarea');
            const saveConstantsBtn = document.getElementById('save-constants-btn');
            const cancelConstantsBtn = document.getElementById('cancel-constants-btn');

            // --- INITIALIZATION ---
            async function initializeApp() {
                try {
                    // Load abilities using the self-contained utilities
                    await UnifiedWinProbabiliyCalculation.loadAbilitiesConfig();
                    ABILITIES_CONFIG = UnifiedWinProbabiliyCalculation.getAbilitiesConfig();

                    const cardsResponse = await fetch(DB_URL);
                    if (!cardsResponse.ok) throw new Error(`Network response for cards was not ok: ${cardsResponse.statusText}`);
                    const cardsData = await cardsResponse.json();
                    
                    allCards = cardsData.cards;
                    setupFuseSearch();
                    
                    // Process abilities for the UI
                    processLoadedAbilities(ABILITIES_CONFIG, `From utilities at ${new Date().toLocaleTimeString()}`);
                    
                    loader.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } catch (error) {
                    console.error("Failed to load from utilities, falling back to manual load:", error);
                    // Fallback to manual loading if utilities fail
                    try {
                        const cardsResponse = await fetch(DB_URL);
                        if (!cardsResponse.ok) throw new Error(`Network response for cards was not ok: ${cardsResponse.statusText}`);
                        const cardsData = await cardsResponse.json();
                        
                        allCards = cardsData.cards;
                        setupFuseSearch();
                        
                        loader.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        
                        warningBanner.innerHTML = `<strong>Could not auto-load abilities from utilities.</strong> Please use the "Load lorcana_abilities.json" button to upload the file manually.`;
                        warningBanner.classList.remove('hidden');
                    } catch (fallbackError) {
                        loader.innerHTML = `<div class="text-red-500 font-bold">Failed to load card database. Please try refreshing the page.</div><p class="text-sm text-slate-500 mt-2">${fallbackError.message}</p>`;
                    }
                }
            }

            function setupFuseSearch() {
                const options = { includeScore: true, keys: ['fullName', 'simpleName'], threshold: 0.3 };
                fuse = new Fuse(allCards, options);
            }

            // --- ABILITY DATA HANDLING ---
            // loadAbilitiesFromUrl function removed - now handled by utilities

            function processLoadedAbilities(data, timestampMessage) {
                try {
                    ABILITIES_CONFIG = data;
                    // Ensure abilities array exists
                    if (!ABILITIES_CONFIG.abilities) ABILITIES_CONFIG.abilities = [];

                    // Update the utilities with the new config
                    UnifiedWinProbabiliyCalculation.setAbilitiesConfig(ABILITIES_CONFIG);

                    const fuseOptions = {
                        keys: ['name', 'category', 'sub_type'],
                        threshold: 0.4,
                        ignoreLocation: true,
                    };
                    abilityFuse = new Fuse(ABILITIES_CONFIG.abilities, fuseOptions);

                    // Regex processing is now handled by utilities, but we still need it for UI
                    ABILITIES_CONFIG.abilities.forEach(p => {
                        if (p.regex && p.regex !== "WILL_NOT_MATCH_TEXT") {
                            try {
                                const match = p.regex.match(/^\/(.*)\/([gimuy]*)$/);
                                p.regexObject = match ? new RegExp(match[1], match[2]) : new RegExp(p.regex, 'gi');
                            } catch (e) {
                                console.error(`Invalid regex for pattern "${p.name}": ${p.regex}`);
                                p.regexObject = null;
                            }
                        }

                        // Add timestamps if missing
                        if (!p.createdAt) {
                            p.createdAt = new Date().toISOString();
                        }
                        if (!p.lastModified) {
                            p.lastModified = new Date().toISOString();
                        }
                    });
                    displayPatterns();
                    buildAndRenderTree(ABILITIES_CONFIG.abilities);
                    lastLoadedTimestamp.textContent = `Last loaded: ${timestampMessage}`;
                    if (selectedCard) displayCardDetails(selectedCard, false);
                    warningBanner.classList.add('hidden');
                } catch (err) {
                    alert('Error processing ability patterns: ' + err.message);
                }
            }

            jsonFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const data = JSON.parse(content);
                        processLoadedAbilities(data, `From file at ${new Date().toLocaleTimeString()}`);
                    } catch (err) {
                        alert('Error parsing JSON file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            });

            saveJsonBtn.addEventListener('click', () => {
                if(!ABILITIES_CONFIG.abilities || ABILITIES_CONFIG.abilities.length === 0) {
                    alert("No ability data loaded to save.");
                    return;
                }
                const patternsToSave = JSON.parse(JSON.stringify(ABILITIES_CONFIG));
                patternsToSave.abilities.forEach(p => delete p.regexObject);

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(patternsToSave, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "lorcana_abilities_redux.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            newAbilityBtn.addEventListener('click', () => {
                const newAbility = {
                    name: "New Ability",
                    category: "Uncategorized",
                    sub_type: "",
                    regex: "//gi",
                    explanation: "",
                    justification: "",
                    lastModified: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    calculation: {
                        variables: [],
                        contextModifiers: [],
                        scores: {}
                    }
                };
                ABILITIES_CONFIG.abilities.unshift(newAbility);
                if (abilityFuse) {
                    abilityFuse.setCollection(ABILITIES_CONFIG.abilities);
                }
                patternFilterInput.value = ''; // Clear filter
                document.querySelectorAll('#tree-nav .tree-nav-item').forEach(el => el.classList.remove('active'));
                const showAll = treeNavContainer.querySelector('[data-filter-type="all"]');
                if (showAll) showAll.classList.add('active');

                displayPatterns();
                buildAndRenderTree(ABILITIES_CONFIG.abilities);
                const firstPattern = patternListContainer.querySelector('[data-index="0"]');
                if (firstPattern) {
                    firstPattern.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstPattern.classList.add('focus-animation');
                }
            });

            saveMdBtn.addEventListener('click', () => {
                if(!ABILITIES_CONFIG.abilities || ABILITIES_CONFIG.abilities.length === 0) {
                    alert("No ability data loaded to save.");
                    return;
                }
                const markdownContent = convertPatternsToMarkdown(ABILITIES_CONFIG.abilities);
                const dataStr = "data:text/markdown;charset=utf-8," + encodeURIComponent(markdownContent);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "lorcana_abilities.md");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            // --- CONSTANTS EDITOR ---
            editConstantsBtn.addEventListener('click', () => {
                if (!ABILITIES_CONFIG['@constants']) {
                    ABILITIES_CONFIG['@constants'] = {};
                }
                const constantsJSON = JSON.stringify(ABILITIES_CONFIG['@constants'], null, 2);
                constantsTextarea.value = constantsJSON;
                constantsModal.classList.remove('hidden');
                constantsTextarea.focus();
            });

            cancelConstantsBtn.addEventListener('click', () => {
                constantsModal.classList.add('hidden');
            });

            saveConstantsBtn.addEventListener('click', () => {
                try {
                    const newConstants = JSON.parse(constantsTextarea.value);
                    ABILITIES_CONFIG['@constants'] = newConstants;
                    constantsModal.classList.add('hidden');
                    
                    // Re-analyze card if one is selected
                    if (selectedCard) {
                        displayCardDetails(selectedCard, false);
                    }
                    alert('Constants saved successfully!');
                } catch (e) {
                    alert('Invalid JSON format: ' + e.message);
                }
            });

            function convertPatternsToMarkdown(patterns) {
                let md = '# Lorcana Ability Patterns\n\n';

                patterns.forEach(p => {
                    md += `## ${p.name || 'Unnamed Ability'}\n\n`;
                    if (p.category) md += `**Category:** ${p.category}\n`;
                    if (p.sub_type) md += `**Sub-type:** ${p.sub_type}\n`;
                    md += '\n';

                    if (p.regex) {
                        md += `### Regex\n`;
                        md += '```\n';
                        md += `${p.regex}\n`;
                        md += '```\n\n';
                    }

                    if (p.explanation) {
                        md += `### Explanation\n`;
                        md += `${p.explanation}\n\n`;
                    }

                    if (p.justification) {
                        md += `### Justification\n`;
                        md += `${p.justification}\n\n`;
                    }

                    if (p.calculation) {
                        md += `### Calculation\n\n`;
                        if (p.calculation.variables && p.calculation.variables.length > 0) {
                            md += `**Variables:**\n`;
                            p.calculation.variables.forEach(v => {
                                md += `- \`${v.name}\`: From \`${v.source}\` (group ${v.group}, type ${v.type})\n`;
                            });
                            md += '\n';
                        }
                        if (p.calculation.contextModifiers && p.calculation.contextModifiers.length > 0) {
                            md += `**Context Modifiers:**\n`;
                            p.calculation.contextModifiers.forEach(m => {
                                md += `- \`${m.name}\` on \`${m.targetMetric}\`: \`${m.operation}\` by \`${m.value}\`\n`;
                            });
                            md += '\n';
                        }
                        if (p.calculation.scores) {
                             md += `**Scores:**\n`;
                            for (const [metric, scoreDef] of Object.entries(p.calculation.scores)) {
                                md += `- **${metric.replace(/_/g, ' ')}:** \`${scoreDef.value}\``;
                                if (scoreDef.condition) md += ` (if \`${scoreDef.condition}\`)`;
                                md += `\n`;
                            }
                        }
                    }


                    md += '\n---\n\n';
                });

                return md;
            }

            // --- EDITOR UI & LOGIC ---
            const createField = (label, type, dataAttr, value, placeholder = '', className = '') => `
                <div class="${className}">
                    <label class="form-label">${label}</label>
                    <${type === 'textarea' ? 'textarea' : 'input'}
                        type="${type === 'textarea' ? '' : 'text'}"
                        class="form-input ${type === 'textarea' ? 'form-textarea' : ''}"
                        ${dataAttr}
                        placeholder="${placeholder}"
                        ${type === 'textarea' ? `rows="2">${value || ''}</textarea>` : `value="${value || ''}">`}
                </div>`;

            function renderVariables(pattern, patternEl) {
                const container = patternEl.querySelector('.variables-container');
                if (!container) return;
                const originalIndex = patternEl.dataset.index;
                container.innerHTML = (pattern.calculation?.variables || []).map((v, i) => `
                    <div class="flex gap-2 items-end p-2 bg-slate-800 rounded" data-variable-index="${i}">
                        ${createField('Name', 'input', `data-path="calculation.variables[${i}].name"`, v.name, 'e.g., drawCount', 'flex-1')}
                        ${createField('Source', 'input', `data-path="calculation.variables[${i}].source"`, v.source, 'regex or card.strength', 'flex-1')}
                        ${createField('Group', 'input', `data-path="calculation.variables[${i}].group"`, v.group, 'e.g., 1', 'w-16')}
                        ${createField('Type', 'input', `data-path="calculation.variables[${i}].type"`, v.type, 'numeric/textOrNumber', 'flex-1')}
                        <button class="px-2 py-1 bg-red-800 text-white rounded h-10" data-action="remove-variable" data-index="${i}">X</button>
                    </div>
                `).join('');
            }

            function renderModifiers(pattern, patternEl) {
                const container = patternEl.querySelector('.modifiers-container');
                if (!container) return;
                const originalIndex = patternEl.dataset.index;
                container.innerHTML = (pattern.calculation?.contextModifiers || []).map((m, i) => `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2 bg-slate-800 rounded" data-modifier-index="${i}">
                        ${createField('Target Metric', 'input', `data-path="calculation.contextModifiers[${i}].targetMetric"`, m.targetMetric, 'lvi, bcr, rds')}
                        ${createField('Name', 'input', `data-path="calculation.contextModifiers[${i}].name"`, m.name, 'e.g., survivability')}
                        ${createField('Operation', 'input', `data-path="calculation.contextModifiers[${i}].operation"`, m.operation, 'multiply, add, set')}
                        ${createField('Value', 'input', `data-path="calculation.contextModifiers[${i}].value"`, m.value, 'e.g., 1.4 or @constants.lvi.wardModifier')}
                        ${createField('Condition (Optional)', 'input', `data-path="calculation.contextModifiers[${i}].condition"`, m.condition, 'e.g., @card.willpower > 5', 'md:col-span-2')}
                        <button class="px-2 py-1 bg-red-800 text-white rounded h-10" data-action="remove-modifier" data-index="${i}">X</button>
                    </div>
                `).join('');
            }
            
            function displayPatterns(patternsToDisplay = ABILITIES_CONFIG.abilities) {
                patternListContainer.innerHTML = '';
                if (patternsToDisplay.length === 0) {
                    patternListContainer.innerHTML = `<div class="text-center text-slate-500 py-10 border-2 border-dashed border-slate-700 rounded-lg"><p>No patterns match the current filter.</p></div>`;
                    return;
                }

                // Sort patterns based on current sort settings
                const sortedPatterns = [...patternsToDisplay].sort((a, b) => {
                    let aValue, bValue;

                    switch (sortField) {
                        case 'name':
                            aValue = (a.name || '').toLowerCase();
                            bValue = (b.name || '').toLowerCase();
                            break;
                        case 'category':
                            aValue = (a.category || 'Uncategorized').toLowerCase();
                            bValue = (b.category || 'Uncategorized').toLowerCase();
                            break;
                        case 'subtype':
                            aValue = (a.sub_type || 'General').toLowerCase();
                            bValue = (b.sub_type || 'General').toLowerCase();
                            break;
                        case 'recent':
                            aValue = new Date(a.lastModified || 0);
                            bValue = new Date(b.lastModified || 0);
                            break;
                        case 'regex':
                            aValue = (a.regex || '').length;
                            bValue = (b.regex || '').length;
                            break;
                        default:
                            aValue = (a.name || '').toLowerCase();
                            bValue = (b.name || '').toLowerCase();
                    }

                    if (sortDirection === 'desc') {
                        return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                    } else {
                        return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                    }
                });

                sortedPatterns.forEach(pattern => {
                    const originalIndex = ABILITIES_CONFIG.abilities.findIndex(p => p === pattern);
                    const patternEl = document.createElement('div');
                    patternEl.className = 'p-4 bg-slate-800 rounded-lg border border-slate-700 transition-colors duration-300';
                    patternEl.setAttribute('data-pattern-name', pattern.name);
                    patternEl.setAttribute('data-index', originalIndex);

                    if (displayMode === 'edit') {
                        // Edit mode - show all input fields
                        patternEl.innerHTML = `
                            <div class="grid grid-cols-1 gap-4">
                                ${createField('Name', 'input', `data-field="name"`, pattern.name)}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${createField('Category', 'input', `data-field="category"`, pattern.category)}
                                    ${createField('Sub-type', 'input', `data-field="sub_type"`, pattern.sub_type)}
                                    ${createField('Value Type', 'input', `data-field="value_type"`, pattern.value_type || 'raw', 'raw or net_advantage')}
                                </div>
                                <div class="mt-4"><label class="form-label cursor-pointer hover:text-blue-400 transition-colors" title="Click to copy this pattern to the Custom Regex Search below">Regex</label><input type="text" class="form-input regex-input" data-field="regex" value="${pattern.regex || ''}" placeholder="e.g., /Draw (\\d+) cards/gi or WILL_NOT_MATCH_TEXT"></div>
                                ${createField('Explanation', 'textarea', `data-field="explanation"`, pattern.explanation)}
                                ${createField('Justification', 'textarea', `data-field="justification"`, pattern.justification)}
                            </div>

                            <h4 class="text-lg font-semibold mt-6 mb-2 text-slate-200 border-t border-slate-700 pt-3">Calculation</h4>
                            <div class="calculation-editor p-3 bg-slate-900/50 rounded-md border border-slate-700 space-y-4">
                                <!-- Variables Section -->
                                <div>
                                    <h5 class="font-semibold text-slate-300 mb-2">Variables</h5>
                                    <div class="variables-container space-y-2">
                                        ${(pattern.calculation?.variables || []).map((v, i) => `
                                            <div class="flex gap-2 items-end p-2 bg-slate-800 rounded" data-variable-index="${i}">
                                                ${createField('Name', 'input', `data-path="calculation.variables[${i}].name"`, v.name, 'e.g., drawCount', 'flex-1')}
                                                ${createField('Source', 'input', `data-path="calculation.variables[${i}].source"`, v.source, 'regex or card.strength', 'flex-1')}
                                                ${createField('Group', 'input', `data-path="calculation.variables[${i}].group"`, v.group, 'e.g., 1', 'w-16')}
                                                ${createField('Type', 'input', `data-path="calculation.variables[${i}].type"`, v.type, 'numeric/textOrNumber', 'flex-1')}
                                                <button class="px-2 py-1 bg-red-800 text-white rounded h-10" data-action="remove-variable" data-index="${i}">X</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button class="mt-2 px-3 py-1 text-sm bg-sky-700 text-white rounded" data-action="add-variable">Add Variable</button>
                                </div>
                                <!-- Context Modifiers Section -->
                                <div>
                                    <h5 class="font-semibold text-slate-300 mb-2">Context Modifiers</h5>
                                    <div class="modifiers-container space-y-2">
                                        ${(pattern.calculation?.contextModifiers || []).map((m, i) => `
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2 bg-slate-800 rounded" data-modifier-index="${i}">
                                                ${createField('Target Metric', 'input', `data-path="calculation.contextModifiers[${i}].targetMetric"`, m.targetMetric, 'lvi, bcr, rds')}
                                                ${createField('Name', 'input', `data-path="calculation.contextModifiers[${i}].name"`, m.name, 'e.g., survivability')}
                                                ${createField('Operation', 'input', `data-path="calculation.contextModifiers[${i}].operation"`, m.operation, 'multiply, add, set')}
                                                ${createField('Value', 'input', `data-path="calculation.contextModifiers[${i}].value"`, m.value, 'e.g., 1.4 or @constants.lvi.wardModifier')}
                                                ${createField('Condition (Optional)', 'input', `data-path="calculation.contextModifiers[${i}].condition"`, m.condition, 'e.g., @card.willpower > 5', 'md:col-span-2')}
                                                <button class="px-2 py-1 bg-red-800 text-white rounded h-10" data-action="remove-modifier" data-index="${i}">X</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button class="mt-2 px-3 py-1 text-sm bg-sky-700 text-white rounded" data-action="add-modifier">Add Modifier</button>
                                </div>
                                <!-- Scores Section -->
                                <div>
                                    <h5 class="font-semibold text-slate-300 mb-2">Scores</h5>
                                    <div class="scores-container grid grid-cols-1 gap-4">
                                        ${['resource_dominance', 'lore_velocity', 'board_control'].map(metric => `
                                            <div class="p-2 bg-slate-800 rounded">
                                                <h6 class="font-medium text-center capitalize text-slate-400 mb-2">${metric.replace('_', ' ')}</h6>
                                                ${createField('Value', 'input', `data-path="calculation.scores.${metric}.value"`, pattern.calculation?.scores?.[metric]?.value)}
                                                ${createField('Explanation', 'input', `data-path="calculation.scores.${metric}.explanation"`, pattern.calculation?.scores?.[metric]?.explanation)}
                                                ${createField('Condition', 'input', `data-path="calculation.scores.${metric}.condition"`, pattern.calculation?.scores?.[metric]?.condition)}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // View mode - show read-only display with only non-blank data
                        const hasVariables = pattern.calculation?.variables && pattern.calculation.variables.length > 0;
                        const hasModifiers = pattern.calculation?.contextModifiers && pattern.calculation.contextModifiers.length > 0;
                        const hasScores = pattern.calculation?.scores && Object.keys(pattern.calculation.scores).length > 0;

                        patternEl.innerHTML = `
                            <div class="space-y-4">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold text-slate-100">${pattern.name || 'Unnamed Ability'}</h3>
                                    <div class="text-sm text-slate-400">
                                        ${pattern.category && pattern.category !== 'Uncategorized' ? `<span class="bg-blue-900/50 px-2 py-1 rounded text-xs">${pattern.category}</span>` : ''}
                                        ${pattern.sub_type && pattern.sub_type !== 'General' ? `<span class="bg-purple-900/50 px-2 py-1 rounded text-xs ml-2">${pattern.sub_type}</span>` : ''}
                                    </div>
                                </div>

                                ${pattern.regex && pattern.regex !== 'WILL_NOT_MATCH_TEXT' ? `
                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-400 mb-1">Regex Pattern</h4>
                                        <code class="block bg-slate-900 p-2 rounded text-sm text-pink-400 font-mono">${pattern.regex}</code>
                                    </div>
                                ` : ''}

                                ${pattern.explanation ? `
                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-400 mb-1">Explanation</h4>
                                        <p class="text-slate-300 text-sm leading-relaxed">${pattern.explanation}</p>
                                    </div>
                                ` : ''}

                                ${pattern.justification ? `
                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-400 mb-1">Justification</h4>
                                        <p class="text-slate-300 text-sm leading-relaxed">${pattern.justification}</p>
                                    </div>
                                ` : ''}

                                ${(hasVariables || hasModifiers || hasScores) ? `
                                    <div class="border-t border-slate-700 pt-4">
                                        <h4 class="text-lg font-semibold text-slate-200 mb-3">Calculation Details</h4>

                                        ${hasVariables ? `
                                            <div class="mb-4">
                                                <h5 class="text-sm font-semibold text-slate-400 mb-2">Variables</h5>
                                                <div class="space-y-2">
                                                    ${pattern.calculation.variables.map(v => `
                                                        <div class="bg-slate-900/50 p-2 rounded text-sm">
                                                            <span class="font-medium text-blue-400">${v.name || 'Unnamed'}</span>
                                                            <span class="text-slate-400">from</span>
                                                            <code class="text-green-400">${v.source || 'N/A'}</code>
                                                            <span class="text-slate-400">(group ${v.group || 'N/A'}, ${v.type || 'N/A'})</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${hasModifiers ? `
                                            <div class="mb-4">
                                                <h5 class="text-sm font-semibold text-slate-400 mb-2">Context Modifiers</h5>
                                                <div class="space-y-2">
                                                    ${pattern.calculation.contextModifiers.map(m => `
                                                        <div class="bg-slate-900/50 p-2 rounded text-sm">
                                                            <span class="font-medium text-purple-400">${m.name || 'Unnamed'}</span>
                                                            <span class="text-slate-400">on</span>
                                                            <code class="text-amber-400">${m.targetMetric || 'N/A'}</code>
                                                            <span class="text-slate-400">${m.operation || 'N/A'} by</span>
                                                            <code class="text-cyan-400">${m.value || 'N/A'}</code>
                                                            ${m.condition ? `<span class="text-slate-400">if</span> <code class="text-orange-400">${m.condition}</code>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${hasScores ? `
                                            <div>
                                                <h5 class="text-sm font-semibold text-slate-400 mb-2">Scores</h5>
                                                <div class="space-y-3">
                                                    ${Object.entries(pattern.calculation.scores).map(([metric, scoreData]) => `
                                                        <div class="bg-slate-900/50 p-3 rounded">
                                                            <h6 class="font-medium text-center capitalize text-slate-300 mb-2">${metric.replace('_', ' ')}</h6>
                                                            ${scoreData.value ? `<div class="text-center text-lg font-bold text-green-400 mb-1">${scoreData.value}</div>` : ''}
                                                            ${scoreData.explanation ? `<div class="text-xs text-slate-400 text-center mb-1">${scoreData.explanation}</div>` : ''}
                                                            ${scoreData.condition ? `<div class="text-xs text-orange-400 text-center">if ${scoreData.condition}</div>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    patternListContainer.appendChild(patternEl);
                });
            }

            function applyFilters() {
                let treeFilteredPatterns = ABILITIES_CONFIG.abilities;

                // 1. Tree Nav filter
                const activeNavItem = treeNavContainer.querySelector('.tree-nav-item.active');
                if (activeNavItem) {
                    const { filterType, filterValue, category, subType, patternName } = activeNavItem.dataset;
                    if (filterType === 'category') {
                        treeFilteredPatterns = ABILITIES_CONFIG.abilities.filter(p => (p.category || 'Uncategorized') === filterValue);
                    } else if (filterType === 'subtype') {
                        treeFilteredPatterns = ABILITIES_CONFIG.abilities.filter(p => (p.category || 'Uncategorized') === category && (p.sub_type || 'General') === subType);
                    } else if (filterType === 'name' && navMode === 'names') {
                        treeFilteredPatterns = ABILITIES_CONFIG.abilities.filter(p => p.name === patternName);
                    }
                }

                // 2. Search term filter
                const searchTerm = patternFilterInput.value.trim();
                if (searchTerm === '') {
                    displayPatterns(treeFilteredPatterns);
                    buildAndRenderTree(treeFilteredPatterns);
                    return;
                }

                if (!abilityFuse) {
                    displayPatterns(treeFilteredPatterns);
                    buildAndRenderTree(treeFilteredPatterns);
                    return;
                }

                const searchResults = abilityFuse.search(searchTerm).map(r => r.item);

                // Intersect searchResults with treeFilteredPatterns
                const treeFilteredPatternsSet = new Set(treeFilteredPatterns);
                const finalPatterns = searchResults.filter(p => treeFilteredPatternsSet.has(p));

                displayPatterns(finalPatterns);
                buildAndRenderTree(finalPatterns);
            }

            patternListContainer.addEventListener('input', (e) => {
                const target = e.target;
                const parentPattern = target.closest('[data-index]');
                if (!parentPattern) return;
 
                const index = parseInt(parentPattern.dataset.index, 10);
                const patternToUpdate = ABILITIES_CONFIG.abilities[index];

                if (target.matches('[data-field]')) {
                    const field = target.dataset.field;
                    patternToUpdate[field] = target.value;
                    patternToUpdate.lastModified = new Date().toISOString(); // Update timestamp
                    if (field === 'name') parentPattern.dataset.patternName = target.value;
                    
                    if (['name', 'category', 'sub_type'].includes(field)) {
                        if (abilityFuse) {
                            abilityFuse.setCollection(ABILITIES_CONFIG.abilities);
                        }
                    }

                    if (field === 'regex') {
                        try {
                            const match = target.value.match(/^\/(.*)\/([gimuy]*)$/);
                            patternToUpdate.regexObject = match ? new RegExp(match[1], match[2]) : new RegExp(target.value, 'gi');
                            target.classList.remove('regex-input-error');
                        } catch (err) {
                            target.classList.add('regex-input-error');
                        }
                    }
                } else if (target.matches('[data-path]')) {
                    const path = target.dataset.path;
                    // Super simple path setter for this specific structure
                    const keys = path.match(/(\w+)|\[(\d+)\]/g).map(k => k.replace(/\[|\]/g, ''));
                    let current = patternToUpdate;
                    for (let i = 0; i < keys.length - 1; i++) {
                        // Ensure path exists
                        if (current[keys[i]] === undefined) {
                           // Check if next key is a number, to create array or object
                           current[keys[i]] = /^\d+$/.test(keys[i+1]) ? [] : {};
                        }
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = target.value;
                }
                
                if (selectedCard) displayCardDetails(selectedCard, false);
                buildAndRenderTree(ABILITIES_CONFIG.abilities); // Update tree on category/name change
            });
            
            patternListContainer.addEventListener('click', (e) => {
                const target = e.target;
                const parentPatternEl = target.closest('[data-pattern-name]');
                if (!parentPatternEl) return;
                const patternIndex = parseInt(parentPatternEl.dataset.index, 10);
                const pattern = ABILITIES_CONFIG.abilities[patternIndex];
                
                const action = target.dataset.action;
                let wasModified = false;

                if (action === 'add-variable') {
                    pattern.calculation.variables = pattern.calculation.variables || [];
                    pattern.calculation.variables.push({ name: "", source: "regex", group: 1, type: "textOrNumber" });
                    renderVariables(pattern, parentPatternEl);
                    wasModified = true;
                } else if (action === 'remove-variable') {
                    const varIndex = parseInt(target.dataset.index, 10);
                    pattern.calculation.variables.splice(varIndex, 1);
                    renderVariables(pattern, parentPatternEl);
                    wasModified = true;
                } else if (action === 'add-modifier') {
                    pattern.calculation.contextModifiers = pattern.calculation.contextModifiers || [];
                    pattern.calculation.contextModifiers.push({ targetMetric: "lvi", name: "survivability", operation: "multiply", value: "1.0" });
                    renderModifiers(pattern, parentPatternEl);
                    wasModified = true;
                } else if (action === 'remove-modifier') {
                    const modIndex = parseInt(target.dataset.index, 10);
                    pattern.calculation.contextModifiers.splice(modIndex, 1);
                    renderModifiers(pattern, parentPatternEl);
                    wasModified = true;
                }

                if (wasModified) {
                    if (selectedCard) displayCardDetails(selectedCard, false);
                    // No full refresh, so focus is maintained.
                }

                // New behavior: click the LABEL to copy regex
                if (target.tagName === 'LABEL' && target.nextElementSibling && target.nextElementSibling.matches('[data-field="regex"]')) {
                    const regexInput = target.nextElementSibling;
                    let regexString = regexInput.value;

                    const match = regexString.match(/^\/(.*)\/([gimuy]*)$/);

                    if (match) {
                        customRegexInput.value = match[1];
                        customRegexFlags.value = match[2] || 'gi'; // Use found flags or default
                    } else {
                        customRegexInput.value = regexString; // Assume no slashes, copy as is
                        customRegexFlags.value = 'gi'; // Default flags
                    }

                    // Expand the custom regex section
                    setRegexSectionState(true);

                    // Focus the custom search section for better UX
                    const customRegexSection = document.getElementById('custom-regex-section');
                    if (customRegexSection) {
                        customRegexSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        customRegexSection.classList.add('focus-animation');
                        setTimeout(() => customRegexSection.classList.remove('focus-animation'), 1500);
                    }
                    customRegexInput.focus();
                }
            });
 
           // --- TREE NAVIGATION ---
            function buildAndRenderTree(patterns) {
                treeNavContainer.innerHTML = '';
                const fragment = document.createDocumentFragment();

                if (navMode === 'names') {
                    // Names view - show individual ability names
                    const sortedPatterns = [...patterns].sort((a, b) => {
                        let aValue, bValue;

                        switch (sortField) {
                            case 'name':
                                aValue = (a.name || '').toLowerCase();
                                bValue = (b.name || '').toLowerCase();
                                break;
                            case 'category':
                                aValue = (a.category || 'Uncategorized').toLowerCase();
                                bValue = (b.category || 'Uncategorized').toLowerCase();
                                break;
                            case 'subtype':
                                aValue = (a.sub_type || 'General').toLowerCase();
                                bValue = (b.sub_type || 'General').toLowerCase();
                                break;
                            case 'recent':
                                aValue = new Date(a.lastModified || 0);
                                bValue = new Date(b.lastModified || 0);
                                break;
                            case 'regex':
                                aValue = (a.regex || '').length;
                                bValue = (b.regex || '').length;
                                break;
                            default:
                                aValue = (a.name || '').toLowerCase();
                                bValue = (b.name || '').toLowerCase();
                        }

                        if (sortDirection === 'desc') {
                            return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                        } else {
                            return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                        }
                    });

                    // Show All button
                    const showAllEl = document.createElement('div');
                    showAllEl.className = 'tree-nav-item active';
                    showAllEl.textContent = 'Show All';
                    showAllEl.dataset.filterType = 'all';
                    const totalCount = document.createElement('span');
                    totalCount.className = 'count';
                    totalCount.textContent = `(${patterns.length})`;
                    showAllEl.appendChild(totalCount);
                    fragment.appendChild(showAllEl);

                    // Individual ability names
                    sortedPatterns.forEach(pattern => {
                        const nameEl = document.createElement('div');
                        nameEl.className = 'tree-nav-item';
                        nameEl.innerHTML = `${pattern.name || 'Unnamed'}<span class="count">(${pattern.category || 'Uncategorized'})</span>`;
                        nameEl.dataset.filterType = 'name';
                        nameEl.dataset.patternName = pattern.name;
                        nameEl.title = `Category: ${pattern.category || 'Uncategorized'}\nSub-type: ${pattern.sub_type || 'General'}`;

                        // Add sort indicator if sorting by name
                        if (sortField === 'name') {
                            const indicator = document.createElement('span');
                            indicator.className = `sort-indicator ${sortDirection} inline-block ml-2`;
                            nameEl.appendChild(indicator);
                        }

                        fragment.appendChild(nameEl);
                    });

                } else {
                    // Categories view - show category tree (original functionality)
                    const sortedPatterns = [...patterns].sort((a, b) => {
                        let aValue, bValue;

                        switch (sortField) {
                            case 'name':
                                aValue = (a.name || '').toLowerCase();
                                bValue = (b.name || '').toLowerCase();
                                break;
                            case 'category':
                                aValue = (a.category || 'Uncategorized').toLowerCase();
                                bValue = (b.category || 'Uncategorized').toLowerCase();
                                break;
                            case 'subtype':
                                aValue = (a.sub_type || 'General').toLowerCase();
                                bValue = (b.sub_type || 'General').toLowerCase();
                                break;
                            case 'recent':
                                aValue = new Date(a.lastModified || 0);
                                bValue = new Date(b.lastModified || 0);
                                break;
                            case 'regex':
                                aValue = (a.regex || '').length;
                                bValue = (b.regex || '').length;
                                break;
                            default:
                                aValue = (a.name || '').toLowerCase();
                                bValue = (b.name || '').toLowerCase();
                        }

                        if (sortDirection === 'desc') {
                            return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                        } else {
                            return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                        }
                    });

                    const tree = {};
                    sortedPatterns.forEach(p => {
                        const category = p.category || 'Uncategorized';
                        const subType = p.sub_type || 'General';
                        if (!tree[category]) tree[category] = {};
                        if (!tree[category][subType]) tree[category][subType] = 0;
                        tree[category][subType]++;
                    });

                    // Show All button
                    const showAllEl = document.createElement('div');
                    showAllEl.className = 'tree-nav-item active';
                    showAllEl.textContent = 'Show All';
                    showAllEl.dataset.filterType = 'all';
                    const totalCount = document.createElement('span');
                    totalCount.className = 'count';
                    totalCount.textContent = `(${patterns.length})`;
                    showAllEl.appendChild(totalCount);
                    fragment.appendChild(showAllEl);

                    Object.keys(tree).sort().forEach(category => {
                        const categoryEl = document.createElement('div');
                        categoryEl.className = 'tree-nav-item';
                        categoryEl.innerHTML = `${category}<span class="count">(${Object.values(tree[category]).reduce((sum, count) => sum + count, 0)})</span>`;
                        categoryEl.dataset.filterType = 'category';
                        categoryEl.dataset.filterValue = category;

                        // Add sort indicator if sorting by category
                        if (sortField === 'category') {
                            const indicator = document.createElement('span');
                            indicator.className = `sort-indicator ${sortDirection} inline-block ml-2`;
                            categoryEl.appendChild(indicator);
                        }

                        fragment.appendChild(categoryEl);

                        if (Object.keys(tree[category]).length > 1 || !tree[category]['General']) {
                            Object.keys(tree[category]).sort().forEach(subType => {
                                const subTypeEl = document.createElement('div');
                                subTypeEl.className = 'tree-nav-item subtype';
                                subTypeEl.innerHTML = `${subType}<span class="count">(${tree[category][subType]})</span>`;
                                subTypeEl.dataset.filterType = 'subtype';
                                subTypeEl.dataset.category = category;
                                subTypeEl.dataset.subType = subType;

                                // Add sort indicator if sorting by subtype
                                if (sortField === 'subtype') {
                                    const indicator = document.createElement('span');
                                    indicator.className = `sort-indicator ${sortDirection} inline-block ml-2`;
                                    subTypeEl.appendChild(indicator);
                                }

                                fragment.appendChild(subTypeEl);
                            });
                        }
                    });
                }

                treeNavContainer.appendChild(fragment);
            }

            treeNavContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.tree-nav-item');
                if (!target) return;
                document.querySelectorAll('#tree-nav .tree-nav-item').forEach(el => el.classList.remove('active'));
                target.classList.add('active');

                if (navMode === 'names' && target.dataset.filterType === 'name') {
                    // In names mode, clicking a name should filter to show only that pattern
                    const patternName = target.dataset.patternName;
                    applyFilters();

                    // Add highlight animation to the selected pattern (same as categories mode)
                    setTimeout(() => {
                        const patternEl = document.querySelector(`#pattern-list [data-pattern-name="${patternName}"]`);
                        if (patternEl) {
                            patternEl.classList.add('focus-animation');
                            setTimeout(() => patternEl.classList.remove('focus-animation'), 1500);
                        }
                    }, 100);
                } else {
                    applyFilters();
                }
            });

            patternFilterInput.addEventListener('input', () => {
                applyFilters();
            });

            sortSelect.addEventListener('change', (e) => {
                currentSort = e.target.value;
                const [field, direction] = currentSort.split('-');
                sortField = field;
                sortDirection = direction;

                // Update visual indicator
                const indicator = document.getElementById('sort-indicator');
                indicator.className = `sort-indicator ${direction}`;

                applyFilters();
                buildAndRenderTree(ABILITIES_CONFIG.abilities); // Rebuild tree with new sort indicators
            });

            navNamesBtn.addEventListener('click', () => {
                navMode = 'names';
                navNamesBtn.classList.add('bg-blue-600');
                navNamesBtn.classList.remove('bg-slate-600');
                navCategoriesBtn.classList.add('bg-slate-600');
                navCategoriesBtn.classList.remove('bg-blue-600');
                buildAndRenderTree(ABILITIES_CONFIG.abilities);
            });

            navCategoriesBtn.addEventListener('click', () => {
                navMode = 'categories';
                navCategoriesBtn.classList.add('bg-blue-600');
                navCategoriesBtn.classList.remove('bg-slate-600');
                navNamesBtn.classList.add('bg-slate-600');
                navNamesBtn.classList.remove('bg-blue-600');
                buildAndRenderTree(ABILITIES_CONFIG.abilities);
            });

            // --- MODE TOGGLE ---
            function updateModeButtons() {
                if (displayMode === 'edit') {
                    editModeBtn.classList.add('bg-blue-600');
                    editModeBtn.classList.remove('bg-slate-600');
                    viewModeBtn.classList.add('bg-slate-600');
                    viewModeBtn.classList.remove('bg-blue-600');
                    newAbilityBtn.classList.remove('hidden');
                } else {
                    viewModeBtn.classList.add('bg-blue-600');
                    viewModeBtn.classList.remove('bg-slate-600');
                    editModeBtn.classList.add('bg-slate-600');
                    editModeBtn.classList.remove('bg-blue-600');
                    newAbilityBtn.classList.add('hidden');
                }
            }

            editModeBtn.addEventListener('click', () => {
                displayMode = 'edit';
                updateModeButtons();
                displayPatterns();
            });

            viewModeBtn.addEventListener('click', () => {
                displayMode = 'view';
                updateModeButtons();
                displayPatterns();
            });

            // --- CARD ANALYSIS & DISPLAY (Right Column) ---
           searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
           searchInput.addEventListener('focus', (e) => { if (e.target.value) handleSearch(e.target.value); });
           document.addEventListener('click', (e) => { if (!e.target.closest('#search-input, #search-results')) searchResultsContainer.classList.add('hidden'); });

            cardDetailsContainer.addEventListener('click', (e) => {
                const clickableElement = e.target.closest('[data-ability-name]');
                if (clickableElement) {
                    const abilityName = clickableElement.dataset.abilityName;

                    // Clear search filter
                    patternFilterInput.value = '';

                    // Find and select the specific ability in navigation
                    const navItem = treeNavContainer.querySelector(`[data-pattern-name="${abilityName}"]`);
                    if (navItem) {
                        // Remove active state from all nav items
                        document.querySelectorAll('#tree-nav .tree-nav-item').forEach(el => el.classList.remove('active'));
                        // Add active state to the specific ability
                        navItem.classList.add('active');

                        // Switch to names mode if not already
                        if (navMode !== 'names') {
                            navMode = 'names';
                            navNamesBtn.classList.add('bg-blue-600');
                            navNamesBtn.classList.remove('bg-slate-600');
                            navCategoriesBtn.classList.add('bg-slate-600');
                            navCategoriesBtn.classList.remove('bg-blue-600');
                            buildAndRenderTree(ABILITIES_CONFIG.abilities);
                        }

                        // Apply filter to show only this ability
                        applyFilters();

                        // Add highlight animation to the pattern
                        setTimeout(() => {
                            const patternEl = document.querySelector(`#pattern-list [data-pattern-name="${abilityName}"]`);
                            if (patternEl) {
                                patternEl.classList.add('focus-animation');
                                setTimeout(() => patternEl.classList.remove('focus-animation'), 1500);
                            }
                        }, 100);
                    } else {
                        // Fallback: if ability not found in navigation, reset to show all
                        const activeNavItem = treeNavContainer.querySelector('.tree-nav-item.active');
                        if (activeNavItem) activeNavItem.classList.remove('active');
                        const showAll = treeNavContainer.querySelector('[data-filter-type="all"]');
                        if (showAll) showAll.classList.add('active');
                        applyFilters();
                    }
                }
            });

            function handleSearch(query) {
                if (query.trim() === '') {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                const results = fuse.search(query, { limit: 10 });
                searchResultsContainer.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(result => {
                        const card = result.item;
                        const resultEl = document.createElement('div');
                        resultEl.className = 'p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-b-0 flex items-center';
                        resultEl.innerHTML = `
                            <img src="${card.images.thumbnail}" alt="${card.fullName}" class="w-10 h-14 mr-3 rounded-sm" onerror="this.style.display='none'">
                            <span class="text-slate-200">${card.fullName}</span>
                        `;
                        resultEl.addEventListener('click', () => displayCardDetails(card, true));
                        searchResultsContainer.appendChild(resultEl);
                    });
                    searchResultsContainer.classList.remove('hidden');
                } else {
                    searchResultsContainer.classList.add('hidden');
                }
            }

            function displayCardDetails(card, updateSearchInput = true) {
                if (!ABILITIES_CONFIG.abilities || ABILITIES_CONFIG.abilities.length === 0) {
                    alert("Please load the abilities JSON file first to analyze cards.");
                    return;
                }
                selectedCard = card;
                if (updateSearchInput) {
                    searchInput.value = card.fullName;
                    searchResultsContainer.classList.add('hidden');
                }

                cardPlaceholder.classList.add('hidden');
                cardDetailsContainer.innerHTML = '';

                const { rds, lvi, bcr, breakdown } = UnifiedWinProbabiliyCalculation.calculateCardMetrics(card);
                const { highlightedHtml, foundPatterns } = analyzeAndHighlightText(card.fullText || (card.fullTextSections || []).join('\n'));

                const resultsHtml = `
                    <h3 class="text-2xl font-bold text-slate-100 mb-4">${card.fullName}</h3>
                    <div class="p-4 bg-slate-800 rounded-lg border border-slate-700 mb-4 flex gap-4 items-start">
                        <img src="${card.images.thumbnail}" alt="${card.fullName}" class="w-40 rounded-lg">
                        <div class="flex-1 prose prose-invert max-w-none">${highlightedHtml}</div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center mb-6 p-4 bg-slate-800 rounded-lg">
                        <div class="bg-purple-900/40 hover:bg-purple-800/70 rounded-xl p-3 flex flex-col items-center justify-center transition-colors duration-200" title="Threat Level =  RDS + LVI + BCR">
                            <div class="text-sm text-slate-400">(CTL) Card Threat Level</div>
                            <div class="text-2xl md:text-3xl font-bold text-purple-400">${(rds + lvi + bcr).toFixed(3)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-400">(RDS) Resource Dominance Score</div>
                            <div class="text-2xl md:text-3xl font-bold text-sky-400">${rds.toFixed(3)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-400">(LVI) Lore Velocity Index</div>
                            <div class="text-2xl md:text-3xl font-bold text-amber-400">${lvi.toFixed(3)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-slate-400">(BCR) Board Control Rating</div>
                            <div class="text-2xl md:text-3xl font-bold text-rose-400">${bcr.toFixed(3)}</div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-slate-300 mb-2">Calculation Breakdown:</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-slate-900">
                                <tr class="border-b border-slate-700">
                                    <th class="text-left p-2">Ability</th>
                                    <th class="text-left p-2">Metric</th>
                                    <th class="text-right p-2">Score</th>
                                    <th class="text-left p-2">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${breakdown.length > 0 ? breakdown.map(item => `
                                    <tr class="border-b border-slate-800 hover:bg-slate-800/50 cursor-pointer" data-ability-name="${item.abilityName}" title="Click to focus on this ability in the editor">
                                        <td class="p-2 font-medium text-slate-200">${item.abilityName}</td>
                                        <td class="p-2 capitalize">${item.metric.replace('_', ' ')}</td>
                                        <td class="text-right p-2 font-mono">${item.value.toFixed(3)}</td>
                                        <td class="p-2 text-slate-400">${item.explanation}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="text-center p-4 text-slate-500">No abilities from the loaded JSON matched this card.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
                cardDetailsContainer.innerHTML = resultsHtml;
                cardDetailsContainer.classList.remove('hidden');

                document.querySelectorAll('.pattern-highlight').forEach(el => el.classList.remove('pattern-highlight'));
                foundPatterns.forEach(pName => {
                    const patternEl = document.querySelector(`#pattern-list [data-pattern-name="${pName}"]`);
                    if (patternEl) patternEl.classList.add('pattern-highlight');
                });
            }

            function analyzeAndHighlightText(originalText) {
                if (!originalText || originalText.trim() === '') {
                    return { highlightedHtml: '', foundPatterns: new Set() };
                }
                const sanitizedText = originalText.replace(/\n/g, ' ');
                let allMatches = [];
                ABILITIES_CONFIG.abilities.forEach(pattern => {
                    if (!pattern.regexObject) return;
                    pattern.regexObject.lastIndex = 0;
                    let match;
                    while ((match = pattern.regexObject.exec(sanitizedText)) !== null) {
                        if (match[0].length === 0) continue;
                        allMatches.push({ name: pattern.name, text: match[0], start: match.index, end: match.index + match[0].length });
                    }
                });

                allMatches.sort((a, b) => a.start - b.start || b.end - a.end);
                const filteredMatches = [];
                let lastEnd = -1;
                for (const match of allMatches) {
                    if (match.start >= lastEnd) {
                        filteredMatches.push(match);
                        lastEnd = match.end;
                    }
                }

                const foundPatterns = new Set(filteredMatches.map(m => m.name));
                const patternColors = {};
                const colorPool = ['#fef9c3', '#dbeafe', '#dcfce7', '#fee2e2', '#e0f2fe', '#f3e8ff', '#ffe4e6', '#d1fae5', '#fae8ff', '#e0e7ff'];
                let colorIndex = 0;
                foundPatterns.forEach(name => {
                    patternColors[name] = colorPool[colorIndex % colorPool.length];
                    colorIndex++;
                });

                let highlightedHtml = "";
                let lastIndex = 0;
                filteredMatches.forEach(match => {
                    highlightedHtml += originalText.substring(lastIndex, match.start);
                    const color = patternColors[match.name];
                    highlightedHtml += `<span class="highlight cursor-pointer" style="background-color: ${color};" data-ability-name="${match.name}" title="Click to focus on this ability in the editor">${match.text}</span>`;
                    lastIndex = match.end;
                });
                highlightedHtml += originalText.substring(lastIndex);
                return { highlightedHtml: highlightedHtml.replace(/\n/g, '<br>'), foundPatterns };
            }

            // Custom Regex Search Button
            customRegexBtn.addEventListener('click', () => {
                const pattern = customRegexInput.value;
                const flags = customRegexFlags.value;
                customRegexError.classList.add('hidden');
                customRegexInput.classList.remove('regex-input-error');
                customRegexResults.innerHTML = '';
                let regex;
                try {
                    regex = new RegExp(pattern, flags);
                } catch (err) {
                    customRegexError.textContent = 'Invalid regex: ' + err.message;
                    customRegexError.classList.remove('hidden');
                    customRegexInput.classList.add('regex-input-error');
                    return;
                }

                // Search all cards for matches
                const results = [];
                const coreFilter = document.getElementById('format-filter-core').checked;
                const infinityFilter = document.getElementById('format-filter-infinity').checked;

                let filteredCards = allCards;

                if (coreFilter) {
                   filteredCards = filteredCards.filter(card => card.allowedInFormats && card.allowedInFormats.Core);
                }
                if (infinityFilter) {
                   filteredCards = filteredCards.filter(card => card.allowedInFormats && card.allowedInFormats.Infinity);
                }

                filteredCards.forEach(card => {
                    let text = card.fullText || '';
                    text = (text).replace(/\n/g, ' ').trim();
                    regex.lastIndex = 0;
                    if (text && regex.test(text)) {
                        results.push({ card, text });
                    }
                });
                const cardResults = results.map(r => r.card);
                lastRegexResults = cardResults;
                displayRegexStats(cardResults);
                copyResultsBtn.classList.toggle('hidden', cardResults.length === 0);

                if (results.length === 0) {
                    customRegexResults.innerHTML = '<div class="text-slate-500">No cards matched this regex.</div>';
                    customRegexStats.innerHTML = ''; // Also clear stats display
                    return;
                }
                // Display results
                const fragment = document.createDocumentFragment();
                results.forEach(({ card, text }) => {
                    // Highlight all matches in the text
                    let highlighted = '';
                    let lastIndex = 0;
                    let match;
                    regex.lastIndex = 0;
                    const matches = [];
                    while ((match = regex.exec(text)) !== null) {
                        if (match[0].length === 0) break;
                        matches.push({ start: match.index, end: match.index + match[0].length });
                        if (!regex.global) break;
                    }
                    matches.forEach((m, i) => {
                        highlighted += text.substring(lastIndex, m.start);
                        highlighted += `<span class="highlight bg-yellow-200">${text.substring(m.start, m.end)}</span>`;
                        lastIndex = m.end;
                    });
                    highlighted += text.substring(lastIndex);

                    const { rds, lvi, bcr } = UnifiedWinProbabiliyCalculation.calculateCardMetrics(card);
                    const ctl = rds + lvi + bcr;

                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'mb-4 p-3 bg-slate-800 rounded-lg border border-slate-700 shadow flex items-start cursor-pointer hover:bg-slate-700 transition-colors';
                    cardDiv.innerHTML = `
                        <img src="${card.images.thumbnail}" alt="${card.fullName}" class="w-16 h-22 mr-4 rounded-md" onerror="this.style.display='none'">
                        <div>
                            <div class="font-bold text-blue-400 mb-1">${card.fullName}</div>
                            <div class="flex gap-3 text-xs mb-2">
                                <span class="font-bold text-purple-400" title="Card Threat Level">CTL: ${ctl.toFixed(2)}</span>
                                <span class="text-sky-400" title="Resource Dominance Score">RDS: ${rds.toFixed(2)}</span>
                                <span class="text-amber-400" title="Lore Velocity Index">LVI: ${lvi.toFixed(2)}</span>
                                <span class="text-rose-400" title="Board Control Rating">BCR: ${bcr.toFixed(2)}</span>
                            </div>
                            <div class="prose prose-sm prose-invert">${highlighted.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    cardDiv.addEventListener('click', () => displayCardDetails(card, true));
                    fragment.appendChild(cardDiv);
                });
                customRegexResults.appendChild(fragment);
            });

            function displayRegexStats(results) {
                if (results.length === 0) {
                    customRegexStats.innerHTML = '';
                    return;
                }

                const total = results.length;
                const inkCounts = results.reduce((acc, card) => {
                    acc[card.color] = (acc[card.color] || 0) + 1;
                    return acc;
                }, {});

                const typeCounts = results.reduce((acc, card) => {
                    acc[card.type] = (acc[card.type] || 0) + 1;
                    return acc;
                }, {});

                const inkOrder = ["Amber","Amethyst","Emerald","Ruby","Sapphire","Steel",
                                "Amber-Steel","Amber-Sapphire","Amber-Emerald","Amber-Ruby","Amber-Amethyst",
                                "Amethyst-Steel","Amethyst-Ruby","Amethyst-Emerald","Amethyst-Sapphire",
                                "Emerald-Ruby","Emerald-Sapphire","Emerald-Steel",
                                "Ruby-Steel","Ruby-Sapphire",
                                "Sapphire-Steel"];
                
                const typeOrder = ['Character', 'Item', 'Action', 'Location', 'Song'];

                let statsHtml = `<div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">`;
                
                statsHtml += `<div><h4 class="font-semibold text-slate-300 mb-1">Ink Distribution (${total} cards)</h4><div class="space-y-1">`;
                inkOrder.forEach(ink => {
                    if (inkCounts[ink]) {
                        const perc = ((inkCounts[ink] / total) * 100).toFixed(1);
                        statsHtml += `<div>${ink}: ${inkCounts[ink]} <span class="text-slate-500">(${perc}%)</span></div>`;
                    }
                });
                statsHtml += `</div></div>`;

                statsHtml += `<div><h4 class="font-semibold text-slate-300 mb-1">Card Type Distribution</h4><div class="space-y-1">`;
                typeOrder.forEach(type => {
                    if (typeCounts[type]) {
                        const perc = ((typeCounts[type] / total) * 100).toFixed(1);
                        statsHtml += `<div>${type}: ${typeCounts[type]} <span class="text-slate-500">(${perc}%)</span></div>`;
                    }
                });
                statsHtml += `</div></div>`;

                statsHtml += `</div>`;
                customRegexStats.innerHTML = statsHtml;
            }

            copyResultsBtn.addEventListener('click', () => {
                if (lastRegexResults.length === 0) return;

                const cardData = lastRegexResults.map(card => {
                    const name = card.fullName;
                    const abilities = (card.fullText || (card.fullTextSections || []).join('\n')).replace(/\n/g, ' ').trim();
                    return `${name}: ${abilities}`;
                }).join('\n\n');
                navigator.clipboard.writeText(cardData).then(() => {
                    const originalText = copyResultsBtn.textContent;
                    copyResultsBtn.textContent = 'Copied!';
                    copyResultsBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    copyResultsBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    setTimeout(() => {
                        copyResultsBtn.textContent = originalText;
                        copyResultsBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        copyResultsBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy card data.');
                });
            });

            // --- FOLDABLE SECTIONS LOGIC ---
            function setEditorSectionState(expand) {
                if (window.innerWidth < 1024) { // Only apply on mobile
                    editorContentWrapper.classList.toggle('max-h-[2000px]', expand); // A large enough max-height
                    editorContentWrapper.classList.toggle('max-h-0', !expand);
                    editorContentWrapper.classList.toggle('py-4', expand);
                    editorContentWrapper.classList.toggle('invisible', !expand);
                    editorSectionChevron.classList.toggle('rotate-180', expand);
                }
            }

            function setCardSearchSectionState(expand) {
                cardSearchContainer.classList.toggle('flex-grow', expand);
                cardSearchWrapper.classList.toggle('grid-rows-[1fr]', expand);
                cardSearchWrapper.classList.toggle('grid-rows-[0fr]', !expand);
                cardSearchChevron.classList.toggle('rotate-180', expand);
            }

            function setRegexSectionState(expand) {
                const regexSection = document.getElementById('custom-regex-section');
                regexSection.classList.toggle('flex-grow', expand);
                customRegexContent.classList.toggle('max-h-[1000px]', expand);
                customRegexContent.classList.toggle('max-h-0', !expand);
                regexSectionChevron.classList.toggle('rotate-180', expand);
            }

            if (toggleCardSearchSection) {
                toggleCardSearchSection.addEventListener('click', () => {
                    const isCardExpanded = cardSearchContainer.classList.contains('flex-grow');
                    setCardSearchSectionState(!isCardExpanded);
                    setRegexSectionState(isCardExpanded);
                });
            }

            if (toggleRegexSection) {
                toggleRegexSection.addEventListener('click', () => {
                    const isRegexExpanded = customRegexContent.classList.contains('max-h-[1000px]');
                    setRegexSectionState(!isRegexExpanded);
                    setCardSearchSectionState(isRegexExpanded);
                });
            }

            if (toggleEditorSection) {
                toggleEditorSection.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        const isEditorExpanded = editorContentWrapper.classList.contains('max-h-[2000px]');
                        setEditorSectionState(!isEditorExpanded);
                    }
                });
            }
 
             // Set initial state
             setEditorSectionState(true);
             setCardSearchSectionState(true);
            setRegexSectionState(false);

            // --- START THE APP ---
            initializeApp();

            // Initialize navigation buttons
            navNamesBtn.classList.add('bg-blue-600');
            navNamesBtn.classList.remove('bg-slate-600');
            navCategoriesBtn.classList.add('bg-slate-600');
            navCategoriesBtn.classList.remove('bg-blue-600');

            // Initialize mode buttons
            updateModeButtons();
            
            // --- INITIALIZE AND MANAGE SPLIT VIEW ---
            setupSplitView();
            window.addEventListener('resize', setupSplitView);
        });
    </script>
</body>

</html>
